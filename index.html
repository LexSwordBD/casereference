<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CaseReference | Smart Legal Research</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- FONTS & COLORS --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&family=Hind+Siliguri:wght@400;500;600&display=swap');
        
        :root {
            --primary: #0f172a;
            --accent: #2563eb;
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --app-btn-color: #27ae60;
        }

        body { 
            background-color: var(--bg-body); 
            font-family: 'Inter', 'Hind Siliguri', sans-serif; 
            color: var(--text-main);
            overflow-x: hidden;
            padding-top: 80px; /* Navbar height fix */
        }

        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }

        /* --- NAVBAR --- */
        .navbar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 12px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }
        .navbar-brand { font-size: 24px; font-weight: 700; color: var(--primary) !important; }
        .navbar-brand span { color: var(--accent); }
        .nav-link { font-weight: 500; color: var(--text-main); margin: 0 10px; font-size: 15px; transition: 0.3s; cursor: pointer; }
        .nav-link:hover { color: var(--accent); }
        
        .btn-app {
            background: var(--surface); border: 1px solid var(--app-btn-color); color: var(--app-btn-color);
            border-radius: 50px; padding: 6px 18px; font-size: 14px; font-weight: 600; 
            display: flex; align-items: center; gap: 8px; transition: 0.3s; text-decoration: none;
        }
        .btn-app:hover { background: var(--app-btn-color); color: white; }

        /* --- HERO SECTION --- */
        .hero-section {
            min-height: 75vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at 50% 50%, #ffffff 0%, #f1f5f9 100%);
            padding: 40px 20px;
            transition: all 0.4s ease;
        }
        
        /* Shrunk State (When Searching) */
        .hero-section.shrunk {
            min-height: auto;
            padding: 40px 20px 20px 20px;
            justify-content: flex-start;
        }
        .hero-section.shrunk .hero-title, 
        .hero-section.shrunk .hero-subtitle {
            display: none;
        }

        .hero-content { text-align: center; width: 100%; max-width: 850px; }
        .hero-title { font-size: 42px; font-weight: 700; color: var(--primary); margin-bottom: 15px; }
        .hero-subtitle { font-size: 17px; color: var(--text-light); margin-bottom: 35px; }

        /* --- SEARCH BAR (Desktop) --- */
        .search-container-box {
            background: var(--surface);
            padding: 8px;
            border-radius: 50px;
            box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0,0,0,0.08);
            display: flex; align-items: center; gap: 5px;
            transition: 0.3s;
        }
        .search-container-box:focus-within {
            box-shadow: 0 20px 50px -10px rgba(37, 99, 235, 0.15);
            border-color: var(--accent);
        }

        .law-select-wrapper { position: relative; width: 35%; border-right: 1px solid #eee; padding-left: 15px; }
        .law-input {
            width: 100%; border: none; font-size: 15px; font-weight: 500; color: var(--primary);
            background: transparent; outline: none; padding: 10px 0;
        }
        
        .main-input {
            flex-grow: 1; border: none; font-size: 16px; outline: none; color: var(--text-main); padding: 10px 15px;
        }

        .btn-search-hero {
            background: var(--accent); color: white; border: none;
            width: 50px; height: 50px; border-radius: 50%;
            font-size: 18px; transition: 0.3s; flex-shrink: 0;
        }
        .btn-search-hero:hover { background: #1d4ed8; transform: scale(1.05); }

        .search-options { display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 13px; color: var(--text-light); }

        /* --- MOBILE OPTIMIZATION (Fixing the box issue) --- */
        @media (max-width: 768px) {
            .hero-section { padding-top: 20px; min-height: auto; }
            .hero-title { font-size: 28px; }
            
            /* Breaking the search bar into separate inputs for mobile */
            .search-container-box {
                flex-direction: column;
                background: transparent;
                box-shadow: none;
                border: none;
                padding: 0;
                gap: 15px;
            }
            
            .law-select-wrapper {
                width: 100%;
                background: white;
                border-radius: 50px;
                border: 1px solid #ddd;
                padding: 5px 20px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            }
            
            .main-input {
                width: 100%;
                background: white;
                border-radius: 50px;
                border: 1px solid #ddd; /* Visible border */
                padding: 15px 20px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            }
            
            .btn-search-hero {
                width: 100%;
                border-radius: 50px;
            }
            
            .btn-filter { display: none; } /* Hide adv icon in main bar on mobile to simplify */
        }

        /* --- RESULTS & CONTENT --- */
        .result-item {
            background: var(--surface); border: 1px solid #e2e8f0;
            padding: 25px; border-radius: 12px; margin-bottom: 15px; 
            transition: 0.2s; cursor: pointer;
        }
        .result-item:hover { border-color: var(--accent); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .result-item h5 { color: #1e293b; font-family: 'Playfair Display', serif; font-weight: 700; margin-bottom: 8px; }
        
        .headnote-text {
            font-size: 16px; color: #475569; line-height: 1.7; margin-top: 10px;
            white-space: pre-wrap; text-align: justify;
            /* Full text shown - no truncation */
        }
        .highlight { background-color: #fef08a; padding: 0 2px; border-radius: 2px; font-weight: bold; }
        .tag-cite { background: #eff6ff; color: var(--accent); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }

        /* --- OTHERS --- */
        .packages-section { padding: 60px 15px; }
        .package-card { background: white; border-radius: 15px; padding: 30px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05); border: 1px solid #eee; margin-bottom: 20px; }
        .btn-pay { display: block; width: 100%; background: var(--primary); color: white; padding: 12px; border-radius: 8px; text-decoration: none; margin-top: 20px; font-weight: 600; }
        
        #readerView { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); font-family: 'Merriweather', serif; font-size: 17px; line-height: 1.8; }
        
        footer { background: #111; color: #aaa; padding: 50px 0; margin-top: 50px; text-align: center; }
        .whatsapp-float { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background-color: #25d366; color: white; border-radius: 50%; text-align: center; line-height: 60px; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; }

        /* Pagination */
        .pagination { justify-content: center; margin-top: 30px; padding-bottom: 50px; }
        .page-link { color: var(--text-main); border: 1px solid #ddd; margin: 0 5px; border-radius: 5px; }
        .page-link:hover, .page-item.active .page-link { background-color: var(--accent); color: white; border-color: var(--accent); }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand brand-font" href="#" onclick="location.reload()">Case<span>Reference</span></a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link nav-link-close" href="#" onclick="resetHome()">Home</a></li>
                    <li class="nav-item"><a class="nav-link nav-link-close" href="#" onclick="showMyBookmarks()">Bookmarks</a></li>
                    <li class="nav-item"><a class="nav-link nav-link-close" href="#packages">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link nav-link-close" href="#contact">Contact</a></li>
                    <li class="nav-item">
                        <a class="btn-app ms-lg-3 mt-3 mt-lg-0" href="#" data-bs-toggle="modal" data-bs-target="#appModal">
                            <i class="fab fa-android"></i> Get App
                        </a>
                    </li>
                    <li class="nav-item ms-lg-3 mt-3 mt-lg-0" id="authDiv"></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="hero-section" id="homeSection">
        <div class="hero-content">
            <h1 class="hero-title">Intelligent Legal Research.</h1>
            <p class="hero-subtitle">Search over 50,000+ judgments from the Supreme Court of Bangladesh.</p>
            
            <div class="search-container-box">
                <div class="law-select-wrapper">
                    <input class="law-input" list="lawList" id="lawFilterInput" placeholder="Select Law (Optional)">
                    <datalist id="lawList">
                        <option value="Constitution of Bangladesh (সংবিধান)">
                        <option value="Code of Civil Procedure (CPC)">
                        <option value="Code of Criminal Procedure (CrPC)">
                        <option value="Penal Code (দণ্ডবিধি)">
                        <option value="Evidence Act (সাক্ষ্য আইন)">
                        <option value="Limitation Act (তামাদি আইন)">
                        <option value="Specific Relief Act (সুনির্দিষ্ট প্রতিকার)">
                        <option value="Nari O Shishu Nirjatan Daman Ain">
                        <option value="Artha Rin Adalat Ain">
                        <option value="Digital Security Act">
                        <option value="Narcotics Control Act">
                        <option value="Special Powers Act">
                        <option value="Anti-Terrorism Act">
                        <option value="Arms Act">
                        <option value="Ain Srinkhola Bighnokari (দ্রুত বিচার)">
                        <option value="Mobile Court Act">
                        <option value="Transfer of Property Act">
                        <option value="Contract Act">
                        <option value="Registration Act">
                        <option value="State Acquisition & Tenancy Act">
                        <option value="Vested Property Return Act">
                        <option value="Trust Act">
                        <option value="Muslim Family Laws">
                        <option value="Family Courts Ordinance">
                        <option value="Guardians and Wards Act">
                        <option value="Hindu Law">
                        <option value="Negotiable Instruments Act (NI Act)">
                        <option value="Bangladesh Labor Act">
                        <option value="Companies Act">
                        <option value="Bank Company Act">
                        <option value="Bankruptcy Act">
                        <option value="VAT Act">
                        <option value="Income Tax Ordinance">
                        <option value="Customs Act">
                        <option value="Right to Information Act">
                        <option value="Road Transport Act">
                    </datalist>
                </div>

                <input type="text" id="searchInput" class="main-input" maxlength="100" placeholder="Search keywords (e.g. Amendment, Bail, Fraud)...">
                
                <button class="btn btn-link text-secondary p-2 d-none d-md-block" onclick="toggleAdvSearch()" title="Advanced Citation Search">
                    <i class="fas fa-sliders-h"></i>
                </button>

                <button class="btn-search-hero" onclick="triggerSearch(1)">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <div class="search-options">
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="exactMatchToggle"> Exact Phrase Match
                </label>
            </div>

            <div id="advSearchForm" style="display:none; background:white; padding:20px; border-radius:12px; margin-top:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); text-align:left; width:100%;">
                <h6 class="small fw-bold text-uppercase text-secondary mb-3">Citation Search</h6>
                <div class="row g-2">
                    <div class="col-6 col-md-3"><select id="advJournal" class="form-select form-select-sm"><option value="">Journal</option><option>DLR</option><option>BLD</option><option>ADC</option><option>MLR</option><option>BLC</option></select></div>
                    <div class="col-6 col-md-2"><input type="text" id="advVol" class="form-control form-control-sm" placeholder="Vol (e.g. 75)"></div>
                    <div class="col-6 col-md-3"><select id="advDiv" class="form-select form-select-sm"><option value="">Division</option><option>AD</option><option>HCD</option></select></div>
                    <div class="col-6 col-md-2"><input type="text" id="advPage" class="form-control form-control-sm" placeholder="Page"></div>
                    <div class="col-12 col-md-2"><button class="btn btn-dark btn-sm w-100" onclick="triggerSearch(1, 'advanced')">Go</button></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="resultsArea"></div>
        <nav id="paginationNav" style="display:none;"><ul class="pagination" id="paginationList"></ul></nav>
        
        <div id="readerView" style="display:none;"></div>
        
        <div id="bookmarkArea" style="display:none;" class="mb-5">
            <h3 class="mb-4 brand-font">My Bookmarks</h3>
            <div id="bookmarkList"></div>
        </div>

        <div id="featuresSection" class="py-5">
            <div class="row g-4 justify-content-center text-center">
                <div class="col-6 col-md-3"><i class="fas fa-bolt fa-2x text-warning mb-3"></i><h6 class="fw-bold">Fast Search</h6></div>
                <div class="col-6 col-md-3"><i class="fas fa-book fa-2x text-primary mb-3"></i><h6 class="fw-bold">All Laws</h6></div>
                <div class="col-6 col-md-3"><i class="fas fa-mobile-alt fa-2x text-success mb-3"></i><h6 class="fw-bold">Mobile First</h6></div>
            </div>
        </div>
    </div>

    <div class="packages-section" id="packages">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="hero-title" style="font-size:32px;">Simple Pricing</h2>
                <p class="text-muted">Choose the plan that fits your practice.</p>
            </div>
            <div class="row g-4 justify-content-center">
                <div class="col-md-3 col-sm-6"><div class="package-card"><h5>Monthly</h5><div class="h3 fw-bold my-2">199৳</div><a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt199/4NosNL" target="_blank" class="btn-pay">Subscribe</a></div></div>
                <div class="col-md-3 col-sm-6"><div class="package-card best-value"><div class="badge-best">POPULAR</div><h5>Quarterly</h5><div class="h3 fw-bold my-2">499৳</div><a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt499/IxcDIa" target="_blank" class="btn-pay">Subscribe</a></div></div>
                <div class="col-md-3 col-sm-6"><div class="package-card"><h5>Yearly</h5><div class="h3 fw-bold my-2">1200৳</div><a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt1200/O3FBxR" target="_blank" class="btn-pay">Subscribe</a></div></div>
            </div>
            <div class="text-center mt-5">
                <button class="btn btn-dark rounded-pill px-5" data-bs-toggle="modal" data-bs-target="#paymentModal">Already paid? Confirm</button>
            </div>
        </div>
    </div>

    <footer id="contact">
        <div class="container">
            <h4 class="brand-font mb-4 text-white">CaseReference</h4>
            <div class="d-flex justify-content-center gap-4 mb-4">
                <a href="#" class="text-secondary text-decoration-none">Terms</a>
                <a href="#" class="text-secondary text-decoration-none">Privacy</a>
                <a href="mailto:legalvoicebd@gmail.com" class="text-secondary text-decoration-none">Contact Support</a>
            </div>
            <p class="text-secondary opacity-50 small">&copy; 2026 CaseReference BD.</p>
        </div>
    </footer>

    <a href="https://wa.me/8801911008518" class="whatsapp-float" target="_blank"><i class="fab fa-whatsapp"></i></a>

    <div class="modal fade" id="appModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4 text-center border-0"><div class="modal-body"><div class="mb-3"><i class="fas fa-mobile-alt fa-3x text-success"></i></div><h3 class="fw-bold">Coming Soon</h3><p class="text-muted">Native Android app is under development.</p><button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Close</button></div></div></div></div>
    <div class="modal fade" id="loginModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Login</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><input type="email" id="loginEmailInput" class="form-control mb-3" placeholder="Email"><button class="btn btn-dark w-100" onclick="submitLogin()">Send Link</button></div></div></div></div>
    <div class="modal fade" id="checkEmailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-check-circle fa-3x text-success mb-3"></i><h3>Check Inbox</h3><p>Login link sent.</p><button class="btn btn-outline-dark" data-bs-dismiss="modal">OK</button></div></div></div></div>
    <div class="modal fade" id="premiumWarningModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-crown fa-3x text-warning mb-3"></i><h3>Premium Only</h3><button class="btn btn-dark mt-3" onclick="triggerLoginFromModal()">Login</button></div></div></div></div>
    <div class="modal fade" id="advSearchGateModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-lock fa-3x text-primary mb-3"></i><h3>Premium Feature</h3><p>Advanced search requires premium.</p><button class="btn btn-primary" onclick="location.href='#packages'; bootstrap.Modal.getInstance(document.getElementById('advSearchGateModal')).hide();">Plans</button></div></div></div></div>
    <div class="modal fade" id="paymentModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Verify Payment</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><form action="https://formsubmit.co/caseref.bd@gmail.com" method="POST"><input type="hidden" name="_captcha" value="false"><input type="text" name="Name" class="form-control mb-2" placeholder="Name" required><input type="text" name="Phone" class="form-control mb-2" placeholder="Phone" required><input type="email" name="Email" class="form-control mb-2" placeholder="Email" required><input type="text" name="TrxID" class="form-control mb-2" placeholder="TrxID" required><select name="Package" class="form-select mb-3"><option>Monthly</option><option>Yearly</option></select><button class="btn btn-success w-100">Submit</button></form></div></div></div></div>
    <div class="modal fade" id="profileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><h4>Profile</h4><div id="profileInfo" class="mb-3"></div><button class="btn btn-danger btn-sm" onclick="logout()">Logout</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const supabaseUrl = 'https://bxzrydybnnlzrgzdqnob.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4enJ5ZHlibm5senJnemRxbm9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTQ2MzksImV4cCI6MjA4NDEzMDYzOX0.6Ikj5At5UKhKZr6y_lhmOQ-FUDxdnJOS1ZUSf6dTgEI'; 
        const githubUser = 'LexSwordBD'; 
        const repoName = 'casereference'; 
        const siteLink = 'https://lexswordbd.github.io/casereference/';

        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        let currentUser = null;
        let subStatus = false;
        let currentPage = 1;
        const itemsPerPage = 20;
        let currentSearchType = 'simple';

        // --- FULL RESTORED LOGIC ---
        const lawAliases = {
            'Constitution of Bangladesh (সংবিধান)': ['Constitution', 'Konstitution', 'Art.', 'Article', 'সংবিধান'],
            'Code of Civil Procedure (CPC/দেওয়ানী)': ['CPC', 'Code of Civil Procedure', 'Civil Procedure Code', 'C.P.C', 'দেওয়ানী কার্যবিধি', 'Order', 'Rule'],
            'Code of Criminal Procedure (CrPC/ফৌজদারী)': ['CrPC', 'Code of Criminal Procedure', 'Criminal Procedure Code', 'Cr.P.C', 'ফৌজদারী কার্যবিধি', 'Section 144', '498'],
            'Penal Code (দণ্ডবিধি)': ['Penal Code', 'Penal', 'PC', 'P.C', 'dondobidhi', 'দণ্ডবিধি', '302', '304'],
            'Evidence Act (সাক্ষ্য আইন)': ['Evidence Act', 'Evidence', 'sakkho ain', 'সাক্ষ্য আইন'],
            'Limitation Act (তামাদি আইন)': ['Limitation Act', 'Limitation', 'Section 5', 'তামাদি'],
            'Specific Relief Act (সুনির্দিষ্ট প্রতিকার)': ['Specific Relief', 'SR Act', 'S.R. Act', 'সুনির্দিষ্ট প্রতিকার'],
            'Nari O Shishu Nirjatan Daman Ain (নারী ও শিশু)': ['Nari O Shishu', 'Women and Children', 'Nari-O-Shishu', 'নারী ও শিশু', 'নারী শিশু'],
            'Artha Rin Adalat Ain (অর্থ ঋণ আদালত)': ['Artha Rin', 'Money Loan Court', 'Artha Rin Adalat', 'অর্থ ঋণ'],
            'Digital Security Act (ডিজিটাল নিরাপত্তা)': ['Digital Security', 'Cyber Security', 'ICT Act', 'ডিজিটাল নিরাপত্তা'],
            'Narcotics Control Act (মাদক দ্রব্য নিয়ন্ত্রণ)': ['Narcotics', 'Madok', 'Drug', 'Table 9(Ka)', 'মাদক', 'Heroin', 'Yaba'],
            'Special Powers Act (বিশেষ ক্ষমতা)': ['Special Powers Act', 'SPA', 'Special Powers', 'বিশেষ ক্ষমতা'],
            'Anti-Terrorism Act (সন্ত্রাস বিরোধী)': ['Anti-Terrorism', 'Terrorism', 'সন্ত্রাস বিরোধী'],
            'Arms Act (অস্ত্র আইন)': ['Arms Act', 'অস্ত্র আইন', 'Arms'],
            'Ain Srinkhola Bighnokari (দ্রুত বিচার)': ['Druto Bichar', 'Speedy Trial', 'দ্রুত বিচার'],
            'Mobile Court Act (মোবাইল কোর্ট)': ['Mobile Court', 'মোবাইল কোর্ট'],
            'Transfer of Property Act (সম্পত্তি হস্তান্তর)': ['Transfer of Property', 'TP Act', 'T.P. Act', 'সম্পত্তি হস্তান্তর'],
            'Contract Act (চুক্তি আইন)': ['Contract Act', 'চুক্তি আইন'],
            'Registration Act (রেজিস্ট্রেশন)': ['Registration Act', 'রেজিস্ট্রেশন'],
            'State Acquisition & Tenancy Act (প্রজাস্বত্ব)': ['State Acquisition', 'SAT Act', 'Non-Agricultural', 'প্রজাস্বত্ব', 'Land Survey'],
            'Vested Property Return Act (অর্পিত সম্পত্তি)': ['Vested Property', 'Enemy Property', 'অর্পিত সম্পত্তি', 'Vested'],
            'Muslim Family Laws (মুসলিম পারিবারিক আইন)': ['Muslim Family', 'Muslim Law', 'মুসলিম পারিবারিক'],
            'Family Courts Ordinance (পারিবারিক আদালত)': ['Family Courts', 'Family Court', 'পারিবারিক আদালত'],
            'Guardians and Wards Act (অভিভাবক ও প্রতিপাল্য)': ['Guardians and Wards', 'Guardian', 'অভিভাবক'],
            'Hindu Law (হিন্দু আইন)': ['Hindu Law', 'Hindu', 'হিন্দু'],
            'Negotiable Instruments Act (NI Act/চেক ডিজঅনার)': ['Negotiable Instruments', 'NI Act', 'N.I. Act', '138', 'Dishonour of Cheque', 'চেক ডিজঅনার'],
            'Bangladesh Labor Act (শ্রম আইন)': ['Labor Act', 'Labour Act', 'Labour Law', 'Employment of Labour', 'Srom Ain', 'শ্রম আইন'],
            'Companies Act (কোম্পানি আইন)': ['Companies Act', 'Company Law', 'Winding up', 'কোম্পানি'],
            'Bank Company Act (ব্যাংক কোম্পানি)': ['Bank Company', 'Banking'],
            'Bankruptcy Act (দেউলিয়া আইন)': ['Bankruptcy', 'Deuliya'],
            'VAT Act (ভ্যাট আইন)': ['Value Added Tax', 'VAT', 'ভ্যাট'],
            'Income Tax Ordinance (আয়কর)': ['Income Tax', 'Tax', 'আয়কর'],
            'Customs Act (কাস্টমস)': ['Customs', 'Custom'],
            'Right to Information Act (তথ্য অধিকার)': ['Right to Information', 'RTI', 'তথ্য অধিকার'],
            'Road Transport Act (সড়ক পরিবহন)': ['Road Transport', 'Motor Vehicle', 'সড়ক পরিবহন']
        };
        const stopwords = ['a', 'an', 'the', 'of', 'in', 'and', 'or', 'is', 'are', 'was', 'were', 'be', 'to', 'for', 'with', 'on', 'at', 'by', 'from', 'shall', 'will', 'am'];

        async function checkAuth() {
            const { data: { session } } = await _supabase.auth.getSession();
            const authDiv = document.getElementById('authDiv');
            if (session) {
                currentUser = session.user;
                const { data } = await _supabase.from('members').select('*').eq('email', currentUser.email).single();
                if(data && new Date(data.expiry_date) > new Date()) subStatus = true;
                authDiv.innerHTML = `<button class="btn btn-outline-dark rounded-pill px-3 btn-sm" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="fas fa-user-circle"></i> Account</button>`;
                document.getElementById('profileInfo').innerHTML = `<p class="fw-bold mb-1">${currentUser.email}</p><span class="badge ${subStatus ? 'bg-success' : 'bg-warning text-dark'}">${subStatus ? 'Premium Member' : 'Free Member'}</span>`;
            } else {
                authDiv.innerHTML = `<button class="btn btn-dark rounded-pill px-4 btn-sm" onclick="openLoginModal()">Login</button>`;
            }
        }
        checkAuth();

        function openLoginModal() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
        async function submitLogin() {
            const email = document.getElementById('loginEmailInput').value;
            if(!email) return alert("Please enter email.");
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            const { error } = await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: siteLink } });
            if(!error) new bootstrap.Modal(document.getElementById('checkEmailModal')).show();
            else alert(error.message);
        }
        function triggerLoginFromModal() { bootstrap.Modal.getInstance(document.getElementById('premiumWarningModal')).hide(); openLoginModal(); }
        async function logout() { await _supabase.auth.signOut(); location.reload(); }

        // --- UI LOGIC ---
        function resetHome() { location.reload(); }
        function toggleAdvSearch() { 
            const panel = document.getElementById('advSearchForm');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        async function showMyBookmarks() {
            if(!currentUser) { openLoginModal(); return; }
            document.getElementById('homeSection').classList.add('shrunk');
            document.getElementById('featuresSection').style.display = 'none';
            document.getElementById('resultsArea').innerHTML = "";
            document.getElementById('readerView').style.display = "none";
            document.getElementById('bookmarkArea').style.display = 'block';
            
            const list = document.getElementById('bookmarkList');
            list.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';
            
            const { data } = await _supabase.from('bookmarks').select('*').eq('email', currentUser.email);
            if(!data || data.length === 0) { list.innerHTML = '<div class="alert alert-light border">No bookmarks found.</div>'; return; }
            
            list.innerHTML = "";
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.onclick = () => loadJudgment({title: item.case_title, citation: item.case_citation, case_anchor: item.case_anchor, github_filename: item.github_filename, is_premium: true});
                div.innerHTML = `<h5>${item.case_title}</h5><span class="tag-cite">${item.case_citation}</span>`;
                list.appendChild(div);
            });
        }

        // --- SEARCH ENGINE ---
        function triggerSearch(page, type = null) { if (type) currentSearchType = type; performSearch(page); }

        async function performSearch(page = 1) {
            currentPage = page;
            const resultsDiv = document.getElementById('resultsArea');
            document.getElementById('readerView').style.display = 'none';
            document.getElementById('bookmarkArea').style.display = 'none';
            document.getElementById('featuresSection').style.display = 'none';
            document.getElementById('packages').style.display = 'none';
            
            // Hero Shrink Logic
            document.getElementById('homeSection').classList.add('shrunk');
            
            // Scroll to Top (Fixes the "Locked" feeling)
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const lawFilterVal = document.getElementById('lawFilterInput').value.trim();
            const searchText = document.getElementById('searchInput').value.trim();

            if (currentSearchType !== 'advanced' && !searchText && !lawFilterVal) { alert("Please enter keyword or select a law."); return; }

            resultsDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            
            let queryBuilder = _supabase.from('cases').select('*', { count: 'exact' });
            let highlightTerm = "";

            if (currentSearchType === 'advanced') {
                const jour = document.getElementById('advJournal').value;
                const vol = document.getElementById('advVol').value;
                const div = document.getElementById('advDiv').value;
                const pg = document.getElementById('advPage').value;
                if (!jour || !vol || !div || !pg) { alert("Please fill all fields."); return; }
                queryBuilder = queryBuilder.eq('journal', jour).eq('volume', vol).eq('division', div).eq('page_number', pg);
                highlightTerm = `${jour} ${vol} ${pg}`;
            } else {
                const isExact = document.getElementById('exactMatchToggle').checked;
                let aliasCondition = "";
                if(lawFilterVal) {
                    for (const [key, aliases] of Object.entries(lawAliases)) {
                        if (key.toLowerCase().includes(lawFilterVal.toLowerCase()) || aliases.some(a => a.toLowerCase().includes(lawFilterVal.toLowerCase()))) {
                            aliasCondition = aliases.map(a => `headnote.ilike.%${a}%`).join(',');
                            break;
                        }
                    }
                    if(!aliasCondition) aliasCondition = `headnote.ilike.%${lawFilterVal}%`;
                }

                if (isExact) {
                    let queryStr = `headnote.ilike.%${searchText}%,title.ilike.%${searchText}%`;
                    if(aliasCondition) queryBuilder = queryBuilder.or(aliasCondition).or(queryStr);
                    else queryBuilder = queryBuilder.or(queryStr);
                    highlightTerm = searchText;
                } else {
                    const words = searchText.split(/\s+/).filter(w => !stopwords.includes(w.toLowerCase()) && w.length > 1);
                    let searchCondition = words.length > 0 ? words.map(w => `headnote.ilike.%${w}%,title.ilike.%${w}%`).join(',') : `headnote.ilike.%${searchText}%,title.ilike.%${searchText}%`;
                    if(aliasCondition) queryBuilder = queryBuilder.or(aliasCondition);
                    if(searchCondition) queryBuilder = queryBuilder.or(searchCondition);
                    highlightTerm = words.join('|');
                }
            }

            const from = (page - 1) * itemsPerPage;
            const to = from + itemsPerPage - 1;
            const { data, error, count } = await queryBuilder.range(from, to).order('page_number', { ascending: true });

            if (currentSearchType === 'advanced' && (!currentUser || !subStatus)) {
                if (count > 0) { new bootstrap.Modal(document.getElementById('advSearchGateModal')).show(); resultsDiv.innerHTML = ''; return; }
            }

            if (error || !data || data.length === 0) {
                resultsDiv.innerHTML = '<div class="text-center mt-5 text-muted"><h5>No cases found.</h5></div>';
                return;
            }

            resultsDiv.innerHTML = `<p class="text-muted small mb-3">Found ${count} results</p>`;
            
            data.forEach(item => {
                const safeHeadnote = item.headnote || "";
                const highlightedHeadnote = highlightText(safeHeadnote, highlightTerm || lawFilterVal);
                
                let citationHtml = (currentUser && subStatus) 
                    ? `<span class="tag-cite">${item.citation}</span> ${item.parallel_citations ? '<span class="parallel-cite">| ' + item.parallel_citations + '</span>' : ''}`
                    : `<span class="badge bg-secondary"><i class="fas fa-lock"></i> Premium</span>`;

                const div = document.createElement('div');
                div.className = 'result-item';
                div.onclick = () => loadJudgment(item);
                div.innerHTML = `
                    <h5>${item.title}</h5>
                    <div class="mb-2">${citationHtml} <span class="badge bg-light text-dark border">${item.division || 'SC'}</span></div>
                    <div class="headnote-text">${highlightedHeadnote}</div>
                `;
                resultsDiv.appendChild(div);
            });
            renderPagination(count, page);
        }

        function renderPagination(totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const nav = document.getElementById('paginationNav');
            const list = document.getElementById('paginationList');
            if (totalPages <= 1) { nav.style.display = 'none'; return; }
            nav.style.display = 'block'; list.innerHTML = '';
            
            list.innerHTML += `<li class="page-item ${currentPage===1?'disabled':''}"><button class="page-link" onclick="triggerSearch(${currentPage-1})"><</button></li>`;
            for(let i=1; i<=totalPages; i++) {
                if(i==1 || i==totalPages || (i >= currentPage-1 && i <= currentPage+1))
                list.innerHTML += `<li class="page-item ${i===currentPage?'active':''}"><button class="page-link" onclick="triggerSearch(${i})">${i}</button></li>`;
            }
            list.innerHTML += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><button class="page-link" onclick="triggerSearch(${currentPage+1})">></button></li>`;
        }

        function highlightText(text, keyword) {
            if (!keyword) return text;
            const parts = keyword.split('|').filter(k => k.length > 0);
            let highlighted = text;
            parts.forEach(part => {
                try {
                    const regex = new RegExp(`(${part})`, "gi");
                    highlighted = highlighted.replace(regex, '<span class="highlight">$1</span>');
                } catch(e) {}
            });
            return highlighted;
        }

        async function loadJudgment(item) {
            if (item.is_premium && !currentUser) { new bootstrap.Modal(document.getElementById('premiumWarningModal')).show(); return; }
            if (item.is_premium && !subStatus) { location.href='#packages'; return; }
            
            document.getElementById('resultsArea').innerHTML = '';
            document.getElementById('paginationNav').style.display = 'none';
            const viewer = document.getElementById('readerView');
            viewer.style.display = 'block';
            viewer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';
            
            try {
                const url = `https://raw.githubusercontent.com/${githubUser}/${repoName}/main/judgments/${item.github_filename}`;
                const res = await fetch(url);
                const fullText = await res.text();
                const start = `===${item.case_anchor}===`;
                const end = `===End===`;
                const sIdx = fullText.indexOf(start);
                let content = sIdx !== -1 ? fullText.substring(sIdx + start.length, fullText.indexOf(end, sIdx)) : "Content Error";
                const searchTerm = document.getElementById('searchInput').value;
                if(searchTerm) content = highlightText(content, searchTerm.replace(/\s+/g, '|'));

                viewer.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="triggerSearch(${currentPage})"><i class="fas fa-arrow-left"></i> Back</button>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning text-dark" onclick="toggleBookmark('${item.title}', '${item.citation}', '${item.case_anchor}', '${item.github_filename}')"><i class="far fa-bookmark"></i> Save</button>
                            <button class="btn btn-sm btn-outline-dark" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                        </div>
                    </div>
                    <h3 class="brand-font fw-bold text-center text-primary mb-2">${item.title}</h3>
                    <p class="text-center text-muted fw-bold mb-4">${item.citation}</p>
                    <div class="mt-4 text-justify" style="white-space: pre-wrap;">${content}</div>
                `;
            } catch (e) { viewer.innerHTML = "Error loading judgment from server."; }
        }

        async function toggleBookmark(title, citation, anchor, file) {
            if(!currentUser) { openLoginModal(); return; }
            const { error } = await _supabase.from('bookmarks').insert([{ email: currentUser.email, case_title: title, case_citation: citation, case_anchor: anchor, github_filename: file }]);
            if(error) alert("Already in bookmarks."); else alert("Saved to bookmarks!");
        }
    </script>
</body>
</html>
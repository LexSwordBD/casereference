<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseReference | Legal Research</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background-color: #f9f9f9; font-family: 'Segoe UI', sans-serif; color: #333; }
        
        /* ‡¶®‡ßç‡¶Ø‡¶æ‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶∞ */
        .navbar { background: #fff; border-bottom: 1px solid #e0e0e0; padding: 15px 0; }
        .brand { font-size: 24px; font-weight: bold; color: #2c3e50; text-decoration: none; }
        .brand span { color: #e67e22; }

        /* ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶∏‡ßá‡¶ï‡¶∂‡¶® (CaseMine ‡¶≤‡ßÅ‡¶ï) */
        .search-hero { text-align: center; padding: 80px 20px; background: #fff; }
        .search-box { 
            max-width: 700px; margin: 20px auto; position: relative; 
            border: 1px solid #dfe1e5; border-radius: 24px; 
            box-shadow: 0 1px 6px rgba(32,33,36,0.1); 
            transition: 0.3s;
        }
        .search-box:hover { box-shadow: 0 1px 10px rgba(32,33,36,0.2); }
        .search-input { 
            width: 100%; border: none; height: 48px; 
            border-radius: 24px; padding: 0 50px 0 20px; outline: none; font-size: 16px; 
        }
        .search-btn { 
            position: absolute; right: 10px; top: 5px; 
            background: none; border: none; color: #e67e22; font-size: 20px; cursor: pointer;
        }

        /* ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶ï‡¶æ‡¶∞‡ßç‡¶° */
        .result-item { 
            background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 8px; 
            border-left: 4px solid transparent; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; 
        }
        .result-item:hover { border-left: 4px solid #e67e22; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .case-header { color: #1a0dab; font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .meta-info { font-size: 13px; color: #5f6368; margin-bottom: 10px; }
        .meta-info span { margin-right: 15px; }
        .snippet { font-size: 14px; color: #4d5156; line-height: 1.5; }

        /* ‡¶∞‡¶ø‡¶°‡¶ø‡¶Ç ‡¶Æ‡ßã‡¶° (‡¶ú‡¶æ‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßú‡¶æ‡¶∞ ‡¶™‡ßá‡¶ú) */
        #readerView { display: none; background: #fff; padding: 40px; border-radius: 8px; margin-top: 20px; }
        .judgment-text { font-family: 'Times New Roman', serif; font-size: 18px; line-height: 1.8; white-space: pre-wrap; text-align: justify; }
        .locked-msg { background: #fff3cd; color: #856404; padding: 20px; text-align: center; border: 1px solid #ffeeba; border-radius: 5px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container d-flex justify-content-between">
            <a href="#" class="brand" onclick="location.reload()"><span>Case</span>Reference</a>
            <div id="authDiv">
                <button class="btn btn-outline-dark btn-sm rounded-pill px-3" onclick="login()">Login</button>
            </div>
        </div>
    </nav>

    <div id="homeSection" class="search-hero">
        <h2>‡¶Ü‡¶á‡¶®‡¶ø ‡¶®‡¶ú‡¶ø‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® ‡¶∏‡¶π‡¶ú‡ßá‡¶á</h2>
        <p class="text-muted">‡¶π‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶π‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶ú‡¶æ‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßá‡¶∏ ‡¶®‡ßã‡¶ü‡¶∏ ‡¶è‡¶∞ ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠</p>
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input" placeholder="Search by Citation (e.g., 75 DLR 45) or Party Name...">
            <button class="search-btn" onclick="performSearch()"><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div class="container mb-5">
        <div id="resultsArea"></div>
        <div id="readerView"></div>
    </div>

   <script>
        // ============================================
        // ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® (Variable Name Fixed)
        // ============================================
        const supabaseUrl = 'https://bxzrydybnnlzrgzdqnob.supabase.co'; 
        
        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶∏‡¶†‡¶ø‡¶ï anon key ‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶∏‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4enJ5ZHlibm5senJnemRxbm9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTQ2MzksImV4cCI6MjA4NDEzMDYzOX0.6Ikj5At5UKhKZr6y_lhmOQ-FUDxdnJOS1ZUSf6dTgEI'; 
        
        const githubUser = 'LexSwordBD'; 
        const repoName = 'casereference'; 
        // ============================================

        // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ‡¶®‡¶æ‡¶Æ supabase ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá _supabase ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ‡¶Ø‡¶æ‡¶§‡ßá ‡¶ï‡¶®‡¶´‡ßç‡¶≤‡¶ø‡¶ï‡ßç‡¶ü ‡¶®‡¶æ ‡¶π‡ßü
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        let currentUser = null;

        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï
        async function checkAuth() {
            // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: _supabase ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('authDiv').innerHTML = `
                    <span class="small me-2">${currentUser.email}</span>
                    <button class="btn btn-danger btn-sm rounded-pill" onclick="logout()">Logout</button>
                `;
            }
        }
        checkAuth();

       async function login() {
            const email = prompt("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶® (Login Link ‡¶Ø‡¶æ‡¶¨‡ßá):");
            if(email) {
                // ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡ßÅ‡¶™‡¶æ‡¶¨‡ßá‡¶ú‡¶ï‡ßá ‡¶ï‡¶°‡¶º‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂ ‡¶¶‡¶ø‡¶ö‡ßç‡¶õ‡¶ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶∂‡ßá‡¶∑‡ßá ‡¶ï‡ßã‡¶•‡¶æ‡ßü ‡¶´‡¶ø‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá
                const { error } = await _supabase.auth.signInWithOtp({ 
                    email: email,
                    options: {
                        // ‡¶è‡¶á ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶è‡¶ï ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá
                        emailRedirectTo: 'https://lexswordbd.github.io/casereference/'
                    }
                });
                
                if(error) alert("Error: " + error.message);
                else alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®!");
            }
        }
        async function logout() { await _supabase.auth.signOut(); location.reload(); }

        // ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        async function performSearch() {
            const query = document.getElementById('searchInput').value;
            if(!query) {
                alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
                return;
            }

            // ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®
            document.getElementById('homeSection').style.padding = "30px 0";
            document.getElementById('homeSection').style.background = "#f8f9fa";
            document.getElementById('readerView').style.display = 'none';

            const resultsDiv = document.getElementById('resultsArea');
            resultsDiv.innerHTML = '<div class="text-center mt-4"><div class="spinner-border text-warning">Loading...</div></div>';

            console.log("Searching for:", query); // ‡¶°‡¶ø‡¶¨‡¶æ‡¶ó‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

            // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ (‡¶´‡¶ø‡¶ï‡ßç‡¶∏: _supabase ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá)
            const { data, error } = await _supabase
                .from('cases')
                .select('*')
                .or(`title.ilike.%${query}%,citation.ilike.%${query}%,headnote.ilike.%${query}%`)
                .limit(20);

            if (error) {
                console.error("Supabase Error:", error); // ‡¶ï‡¶®‡¶∏‡ßã‡¶≤‡ßá ‡¶è‡¶∞‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                resultsDiv.innerHTML = `<div class="alert alert-danger text-center mt-4">Database Error: ${error.message}</div>`;
                return;
            }

            if (!data || data.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-light text-center mt-4">No cases found. Try searching "75 DLR".</div>';
                return;
            }

            // ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
            resultsDiv.innerHTML = `<p class="text-muted mt-3 mb-2">Found ${data.length} results</p>`;
            
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.onclick = () => loadJudgment(item);
                div.innerHTML = `
                    <div class="case-header">${item.title}</div>
                    <div class="meta-info">
                        <span><i class="fas fa-gavel"></i> ${item.court || 'Court'}</span>
                        <span><i class="fas fa-calendar"></i> ${item.year || 'Year'}</span>
                        <span class="badge bg-secondary text-light">${item.citation || 'Unreported'}</span>
                        ${item.is_premium ? '<span class="text-danger ms-2"><i class="fas fa-lock"></i> Premium</span>' : ''}
                    </div>
                    <div class="snippet">${item.headnote ? item.headnote.substring(0, 200) : ''}...</div>
                `;
                resultsDiv.appendChild(div);
            });
        }

        // ‡¶ú‡¶æ‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        async function loadJudgment(item) {
            if(item.is_premium && !currentUser) {
                alert("üîí This case is Premium. Please Login to read full text.");
                login();
                return;
            }

            document.getElementById('resultsArea').innerHTML = '';
            const viewer = document.getElementById('readerView');
            viewer.style.display = 'block';
            viewer.innerHTML = '<div class="text-center">Fetching from Archive...</div>';

            const url = `https://raw.githubusercontent.com/${githubUser}/${repoName}/main/judgments/${item.github_filename}`;
            console.log("Fetching URL:", url);

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("GitHub file not found (404)");
                const fullText = await response.text();

                // ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
                const startMarker = `===${item.case_anchor}===`;
                const endMarker = `===End===`;

                const sIndex = fullText.indexOf(startMarker);
                let content = "Judgment content marker not found in file. Please check 'case_anchor' in database.";

                if (sIndex !== -1) {
                    const eIndex = fullText.indexOf(endMarker, sIndex);
                    if (eIndex !== -1) {
                        content = fullText.substring(sIndex + startMarker.length, eIndex);
                    }
                }

                viewer.innerHTML = `
                    <button class="btn btn-sm btn-outline-secondary mb-3" onclick="performSearch()">Back to Results</button>
                    <h2 class="text-center mb-2">${item.title}</h2>
                    <p class="text-center text-muted fw-bold">${item.citation}</p>
                    <hr>
                    <div class="judgment-text">${content}</div>
                    <hr>
                    <div class="text-center mt-4">
                        <button class="btn btn-warning" onclick="window.print()">Print Case</button>
                    </div>
                `;

            } catch (err) {
                console.error(err);
                viewer.innerHTML = `<div class="alert alert-danger">Error loading file: ${err.message}</div>`;
            }
        }
    </script>
</body>

</html>



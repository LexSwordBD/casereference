<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CaseReference | The Legal Intelligence</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- 1. PREMIUM TYPOGRAPHY & COLORS --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&family=Hind+Siliguri:wght@400;500;600&display=swap');
        
        :root {
            --primary: #0f172a;       /* Deep Navy - Authority */
            --accent: #2563eb;        /* Royal Blue - Trust */
            --gold: #d97706;          /* Gold - Premium */
            --bg-body: #f8fafc;       /* Ultra Light Blue-Grey */
            --surface: #ffffff;       /* Pure White */
            --text-main: #1e293b;
            --text-light: #64748b;
            --border-radius: 12px;
        }

        body { 
            background-color: var(--bg-body); 
            font-family: 'Inter', 'Hind Siliguri', sans-serif; 
            color: var(--text-main);
            overflow-x: hidden;
        }

        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }

        /* --- 2. GLASSMORPHISM NAVBAR --- */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 15px 0;
        }
        .navbar-brand { font-size: 26px; font-weight: 700; color: var(--primary) !important; letter-spacing: -0.5px; }
        .nav-link { font-weight: 500; color: var(--text-main); font-size: 14px; margin: 0 10px; transition: 0.3s; }
        .nav-link:hover { color: var(--accent); }
        
        /* Premium App Button */
        .btn-app {
            background: var(--text-main); color: white; border-radius: 50px;
            padding: 8px 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .btn-app:hover { background: var(--accent); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        /* --- 3. MODERN HERO SECTION (Centered & Clean) --- */
        .hero-section {
            min-height: 85vh; /* Full screen feel */
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at 50% 50%, #ffffff 0%, #f1f5f9 100%);
            position: relative;
            padding: 20px;
        }
        
        .hero-content { text-align: center; width: 100%; max-width: 800px; z-index: 2; }
        .hero-title { font-size: 48px; font-weight: 700; color: var(--primary); margin-bottom: 15px; line-height: 1.2; }
        .hero-subtitle { font-size: 18px; color: var(--text-light); margin-bottom: 40px; font-weight: 300; }

        /* --- 4. THE ULTIMATE SEARCH BAR (Unified) --- */
        .search-container-box {
            background: var(--surface);
            padding: 10px;
            border-radius: 16px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.3s;
        }
        .search-container-box:focus-within {
            box-shadow: 0 20px 60px -12px rgba(37, 99, 235, 0.15);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        /* Law Filter inside search */
        .law-select-wrapper {
            position: relative;
            min-width: 180px;
            border-right: 1px solid #eee;
            padding-right: 10px;
        }
        .law-input {
            width: 100%; border: none; font-size: 14px; font-weight: 600; color: var(--primary);
            background: transparent; outline: none; padding: 10px; cursor: pointer;
        }
        .law-input::placeholder { color: var(--text-main); }

        /* Main Search Input */
        .main-input {
            flex-grow: 1; border: none; font-size: 16px; outline: none; color: var(--text-main); padding: 10px;
        }

        /* Search Button */
        .btn-search-hero {
            background: var(--accent); color: white; border: none;
            width: 50px; height: 50px; border-radius: 12px;
            font-size: 18px; transition: 0.3s; cursor: pointer;
        }
        .btn-search-hero:hover { background: #1d4ed8; }

        /* Options Row below search */
        .search-options { display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 13px; color: var(--text-light); }
        .option-item { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .option-item input { cursor: pointer; }

        /* --- 5. RESULT LIST (Professional List View) --- */
        .result-item {
            background: var(--surface); border: 1px solid #f1f5f9;
            padding: 25px; border-radius: var(--border-radius);
            margin-bottom: 15px; transition: 0.2s; position: relative;
            cursor: pointer;
        }
        .result-item:hover {
            border-color: var(--accent);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .result-item h5 {
            color: var(--accent); font-family: 'Playfair Display', serif; font-weight: 700; font-size: 20px; margin-bottom: 8px;
        }
        .meta-tags { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .tag {
            font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .tag-cite { background: #eff6ff; color: var(--accent); }
        .tag-law { background: #f8fafc; color: var(--text-light); border: 1px solid #e2e8f0; }
        
        .headnote-preview {
            font-size: 15px; color: #475569; line-height: 1.6;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        .highlight { background-color: #fef08a; padding: 0 2px; border-radius: 2px; color: #854d0e; }

        /* --- 6. MODERN PRICING --- */
        .pricing-card {
            background: var(--surface); padding: 40px; border-radius: 20px; text-align: center;
            border: 1px solid #f1f5f9; transition: 0.3s; position: relative; overflow: hidden;
        }
        .pricing-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .pricing-card.popular { border: 2px solid var(--accent); }
        .popular-badge {
            background: var(--accent); color: white; padding: 5px 30px; font-size: 11px; font-weight: 700;
            text-transform: uppercase; position: absolute; top: 20px; right: -30px; transform: rotate(45deg);
        }
        .price { font-size: 32px; font-weight: 700; color: var(--primary); margin: 15px 0; font-family: 'Inter', sans-serif; }
        .btn-price {
            display: block; width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; text-decoration: none; margin-top: 20px;
            background: #f1f5f9; color: var(--primary); transition: 0.3s;
        }
        .btn-price:hover, .pricing-card.popular .btn-price { background: var(--primary); color: white; }

        /* Reader View */
        #readerView { font-family: 'Merriweather', serif; font-size: 17px; line-height: 1.8; color: #334155; }

        /* Footer */
        footer { background: #fff; border-top: 1px solid #eee; padding: 60px 0 30px; margin-top: 80px; }
        
        /* Mobile Tweaks */
        @media (max-width: 768px) {
            .hero-title { font-size: 32px; }
            .hero-section { min-height: auto; padding-top: 120px; padding-bottom: 60px; }
            .search-container-box { flex-direction: column; padding: 15px; gap: 15px; }
            .law-select-wrapper { width: 100%; border-right: none; border-bottom: 1px solid #eee; }
            .btn-search-hero { width: 100%; height: 45px; border-radius: 8px; }
            .search-options { flex-direction: column; gap: 10px; align-items: center; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand brand-font" href="#" onclick="location.reload()">Case<span>Reference</span></a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="resetHome()">Research</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showMyBookmarks()">Bookmarks</a></li>
                    <li class="nav-item"><a class="nav-link" href="#packages">Pricing</a></li>
                    <li class="nav-item"><a class="btn-app ms-lg-3 mt-3 mt-lg-0" href="#" data-bs-toggle="modal" data-bs-target="#appModal">
                        <i class="fab fa-apple"></i> <i class="fab fa-android"></i> Get App
                    </a></li>
                    <li class="nav-item ms-lg-3 mt-3 mt-lg-0" id="authDiv"></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="hero-section" id="homeSection">
        <div class="hero-content">
            <h1 class="hero-title">Intelligent Legal Research.</h1>
            <p class="hero-subtitle">Search over 50,000+ judgments from the Supreme Court of Bangladesh.</p>
            
            <div class="search-container-box">
                <div class="law-select-wrapper">
                    <input class="law-input" list="lawList" id="lawFilterInput" placeholder="Select Law (Optional)">
                    <datalist id="lawList">
                        <option value="Constitution of Bangladesh">
                        <option value="Code of Civil Procedure (CPC)">
                        <option value="Code of Criminal Procedure (CrPC)">
                        <option value="Penal Code">
                        <option value="Evidence Act">
                        <option value="Specific Relief Act">
                        <option value="Limitation Act">
                        <option value="Transfer of Property Act">
                        <option value="Contract Act">
                        <option value="Nari O Shishu Nirjatan Daman Ain">
                        <option value="Artha Rin Adalat Ain">
                        <option value="Digital Security Act">
                        <option value="Labor Act">
                        <option value="Narcotics Control Act">
                        <option value="Special Powers Act">
                        <option value="Arms Act">
                        <option value="Vested Property Return Act">
                        <option value="Family Courts Ordinance">
                        <option value="Muslim Family Laws">
                        <option value="Negotiable Instruments Act (NI Act)">
                        <option value="VAT Act">
                        <option value="Income Tax Ordinance">
                    </datalist>
                </div>

                <input type="text" id="searchInput" class="main-input" maxlength="100" placeholder="Search for keywords, citations, or case names...">
                
                <button class="btn btn-link text-secondary p-2" onclick="toggleAdvSearch()" title="Advanced Citation Search">
                    <i class="fas fa-sliders-h"></i>
                </button>

                <button class="btn-search-hero" onclick="triggerSearch(1)">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <div class="search-options">
                <label class="option-item">
                    <input type="checkbox" id="exactMatchToggle"> Exact Phrase Match
                </label>
            </div>

            <div id="advSearchForm" style="display:none; background:white; padding:20px; border-radius:12px; margin-top:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); text-align:left;">
                <h6 class="small fw-bold text-uppercase text-secondary mb-3">Citation Search</h6>
                <div class="row g-2">
                    <div class="col-6 col-md-3"><select id="advJournal" class="form-select form-select-sm"><option value="">Journal</option><option>DLR</option><option>BLD</option><option>ADC</option><option>MLR</option><option>BLC</option></select></div>
                    <div class="col-6 col-md-2"><input type="text" id="advVol" class="form-control form-control-sm" placeholder="Vol (e.g. 75)"></div>
                    <div class="col-6 col-md-3"><select id="advDiv" class="form-select form-select-sm"><option value="">Division</option><option>AD</option><option>HCD</option></select></div>
                    <div class="col-6 col-md-2"><input type="text" id="advPage" class="form-control form-control-sm" placeholder="Page"></div>
                    <div class="col-12 col-md-2"><button class="btn btn-dark btn-sm w-100" onclick="triggerSearch(1, 'advanced')">Go</button></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="min-height: 400px;">
        <div id="resultsArea"></div>
        <nav id="paginationNav" style="display:none;"><ul class="pagination" id="paginationList"></ul></nav>
        
        <div id="readerView" class="bg-white p-4 p-md-5 rounded-3 shadow-sm border mb-5" style="display:none;"></div>
        
        <div id="bookmarkArea" style="display:none;" class="mb-5">
            <h3 class="mb-4 brand-font">My Bookmarks</h3>
            <div id="bookmarkList"></div>
        </div>

        <div id="featuresSection" class="py-5">
            <div class="row g-4 justify-content-center text-center">
                <div class="col-6 col-md-3">
                    <div class="p-3">
                        <i class="fas fa-bolt fa-2x text-warning mb-3"></i>
                        <h6 class="fw-bold">Lightning Fast</h6>
                        <p class="small text-muted">Instant results powered by smart indexing.</p>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="p-3">
                        <i class="fas fa-book fa-2x text-primary mb-3"></i>
                        <h6 class="fw-bold">Comprehensive</h6>
                        <p class="small text-muted">All major laws and journals covered.</p>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="p-3">
                        <i class="fas fa-mobile-alt fa-2x text-success mb-3"></i>
                        <h6 class="fw-bold">Mobile First</h6>
                        <p class="small text-muted">Optimized reading experience on any device.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="packages-section" id="packages">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="hero-title" style="font-size:32px;">Simple, Transparent Pricing</h2>
                <p class="text-muted">Choose the plan that fits your practice.</p>
            </div>
            <div class="row g-4 justify-content-center">
                <div class="col-md-3 col-sm-6">
                    <div class="pricing-card">
                        <h5 class="fw-bold">Monthly</h5>
                        <div class="price">199৳</div>
                        <p class="small text-muted">Billed monthly</p>
                        <a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt199/4NosNL" target="_blank" class="btn-price">Get Started</a>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="pricing-card popular">
                        <div class="popular-badge">Best Value</div>
                        <h5 class="fw-bold">Quarterly</h5>
                        <div class="price">499৳</div>
                        <p class="small text-muted">Save 15%</p>
                        <a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt499/IxcDIa" target="_blank" class="btn-price">Get Started</a>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="pricing-card">
                        <h5 class="fw-bold">Yearly</h5>
                        <div class="price">1200৳</div>
                        <p class="small text-muted">Save 50%</p>
                        <a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt1200/O3FBxR" target="_blank" class="btn-price">Get Started</a>
                    </div>
                </div>
            </div>
            <div class="text-center mt-5">
                <button class="btn btn-dark rounded-pill px-5" data-bs-toggle="modal" data-bs-target="#paymentModal">
                    Already paid? Confirm here
                </button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <h4 class="brand-font mb-4 text-white">CaseReference</h4>
            <div class="d-flex justify-content-center gap-4 mb-4">
                <a href="#" class="text-secondary text-decoration-none">Terms</a>
                <a href="#" class="text-secondary text-decoration-none">Privacy</a>
                <a href="#contact" class="text-secondary text-decoration-none">Contact</a>
            </div>
            <p class="text-secondary opacity-50 small">&copy; 2026 CaseReference BD. All rights reserved.</p>
        </div>
    </footer>

    <a href="https://wa.me/8801911008518" class="whatsapp-float" target="_blank"><i class="fab fa-whatsapp"></i></a>

    <div class="modal fade" id="appModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 text-center border-0">
                <div class="modal-body">
                    <div class="mb-3"><i class="fas fa-mobile-alt fa-3x text-success"></i></div>
                    <h3 class="brand-font fw-bold">Coming Soon</h3>
                    <p class="text-muted">We are building a native experience for iOS and Android. Stay tuned!</p>
                    <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Welcome Back</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><p class="text-muted mb-3">Enter your email to receive a magic login link.</p><input type="email" id="loginEmailInput" class="form-control mb-3" placeholder="name@company.com"><button class="btn btn-dark w-100 py-2" onclick="submitLogin()">Send Magic Link</button></div></div></div></div>
    
    <div class="modal fade" id="checkEmailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-envelope-open-text fa-3x text-success mb-3"></i><h3>Check your inbox</h3><p class="text-muted">We've sent you a secure login link.</p><button class="btn btn-outline-dark mt-3" data-bs-dismiss="modal">Okay</button></div></div></div></div>

    <div class="modal fade" id="premiumWarningModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-crown fa-3x text-warning mb-3"></i><h3>Premium Content</h3><p class="text-muted">Please login or subscribe to view this judgment.</p><button class="btn btn-dark mt-3" onclick="triggerLoginFromModal()">Login / Subscribe</button></div></div></div></div>

    <div class="modal fade" id="advSearchGateModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-search-plus fa-3x text-primary mb-3"></i><h3>Advanced Search</h3><p class="text-muted">This powerful tool is available for Premium members only.</p><button class="btn btn-primary mt-3" onclick="location.href='#packages'; bootstrap.Modal.getInstance(document.getElementById('advSearchGateModal')).hide();">View Plans</button></div></div></div></div>

    <div class="modal fade" id="paymentModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Payment Verification</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><form action="https://formsubmit.co/caseref.bd@gmail.com" method="POST"><input type="hidden" name="_captcha" value="false"><input type="hidden" name="_subject" value="New Payment"><div class="mb-3"><label class="form-label">Name</label><input type="text" name="Name" class="form-control" required></div><div class="mb-3"><label class="form-label">Phone</label><input type="text" name="Phone" class="form-control" required></div><div class="mb-3"><label class="form-label">Email</label><input type="email" name="Email" class="form-control" required></div><div class="row"><div class="col-6 mb-3"><label class="form-label">TrxID</label><input type="text" name="TrxID" class="form-control" required></div><div class="col-6 mb-3"><label class="form-label">Plan</label><select name="Package" class="form-select"><option>Monthly</option><option>Quarterly</option><option>Yearly</option></select></div></div><button class="btn btn-success w-100 py-2">Submit</button></form></div></div></div></div>

    <div class="modal fade" id="profileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><h4 class="mb-3">My Profile</h4><div id="profileInfo" class="mb-4"></div><button class="btn btn-outline-danger btn-sm" onclick="logout()">Sign Out</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- CONFIGURATION ---
        const supabaseUrl = 'https://bxzrydybnnlzrgzdqnob.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4enJ5ZHlibm5senJnemRxbm9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTQ2MzksImV4cCI6MjA4NDEzMDYzOX0.6Ikj5At5UKhKZr6y_lhmOQ-FUDxdnJOS1ZUSf6dTgEI'; 
        const githubUser = 'LexSwordBD'; 
        const repoName = 'casereference'; 
        const siteLink = 'https://lexswordbd.github.io/casereference/';

        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        let currentUser = null;
        let subStatus = false;
        let currentPage = 1;
        const itemsPerPage = 20;
        let currentSearchType = 'simple';

        // --- SMART ALIAS SYSTEM (English + Bangla) ---
        const lawAliases = {
            'Constitution': ['Constitution', 'Konstitution', 'Art.', 'Article', 'সংবিধান'],
            'Code of Civil Procedure': ['CPC', 'Code of Civil Procedure', 'Civil Procedure Code', 'C.P.C', 'দেওয়ানী কার্যবিধি', 'Order', 'Rule'],
            'Code of Criminal Procedure': ['CrPC', 'Code of Criminal Procedure', 'Criminal Procedure Code', 'Cr.P.C', 'ফৌজদারী কার্যবিধি', 'Section 144', '498'],
            'Penal Code': ['Penal Code', 'Penal', 'PC', 'P.C', 'dondobidhi', 'দণ্ডবিধি', '302', '304'],
            'Evidence Act': ['Evidence Act', 'Evidence', 'sakkho ain', 'সাক্ষ্য আইন'],
            'Limitation Act': ['Limitation Act', 'Limitation', 'Section 5', 'তামাদি'],
            'Specific Relief Act': ['Specific Relief', 'SR Act', 'S.R. Act', 'সুনির্দিষ্ট প্রতিকার'],
            'Nari O Shishu': ['Nari O Shishu', 'Women and Children', 'Nari-O-Shishu', 'নারী ও শিশু'],
            'Artha Rin': ['Artha Rin', 'Money Loan Court', 'Artha Rin Adalat', 'অর্থ ঋণ'],
            'Digital Security': ['Digital Security', 'Cyber Security', 'ICT Act', 'ডিজিটাল নিরাপত্তা'],
            'Narcotics': ['Narcotics', 'Madok', 'Drug', 'Table 9(Ka)', 'মাদক', 'Heroin', 'Yaba'],
            'Labor Act': ['Labor Act', 'Labour Act', 'Labour Law', 'Employment of Labour', 'Srom Ain', 'শ্রম আইন'],
            'Negotiable Instruments': ['Negotiable Instruments', 'NI Act', 'N.I. Act', '138', 'Dishonour of Cheque', 'চেক ডিজঅনার'],
            'Companies Act': ['Companies Act', 'Company Law', 'Winding up', 'কোম্পানি'],
            'Transfer of Property': ['Transfer of Property', 'TP Act', 'T.P. Act', 'সম্পত্তি হস্তান্তর'],
            'Registration Act': ['Registration Act', 'রেজিস্ট্রেশন']
        };
        const stopwords = ['a', 'an', 'the', 'of', 'in', 'and', 'or', 'is', 'are', 'was', 'were', 'be', 'to', 'for', 'with', 'on', 'at', 'by', 'from', 'shall', 'will', 'am'];

        // --- AUTH LOGIC ---
        async function checkAuth() {
            const { data: { session } } = await _supabase.auth.getSession();
            const authDiv = document.getElementById('authDiv');
            if (session) {
                currentUser = session.user;
                const { data } = await _supabase.from('members').select('*').eq('email', currentUser.email).single();
                if(data && new Date(data.expiry_date) > new Date()) subStatus = true;
                
                authDiv.innerHTML = `<button class="btn btn-outline-dark rounded-pill px-3 btn-sm" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="fas fa-user-circle"></i> Account</button>`;
                document.getElementById('profileInfo').innerHTML = `<p class="fw-bold mb-1">${currentUser.email}</p><span class="badge ${subStatus ? 'bg-success' : 'bg-warning text-dark'}">${subStatus ? 'Premium Member' : 'Free Member'}</span>`;
            } else {
                authDiv.innerHTML = `<button class="btn btn-dark rounded-pill px-4 btn-sm" onclick="openLoginModal()">Login</button>`;
            }
        }
        checkAuth();

        function openLoginModal() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
        async function submitLogin() {
            const email = document.getElementById('loginEmailInput').value;
            if(!email) return alert("Please enter email.");
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            const { error } = await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: siteLink } });
            if(!error) new bootstrap.Modal(document.getElementById('checkEmailModal')).show();
            else alert(error.message);
        }
        function triggerLoginFromModal() { bootstrap.Modal.getInstance(document.getElementById('premiumWarningModal')).hide(); openLoginModal(); }
        async function logout() { await _supabase.auth.signOut(); location.reload(); }

        // --- UI LOGIC ---
        function resetHome() { location.reload(); }
        function toggleAdvSearch() { 
            const panel = document.getElementById('advSearchForm');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        function showSection(id) {
            document.getElementById('homeSection').style.display = 'none'; // Hide hero to show content
            // Logic to show specific section... 
            // For now simplified as mostly dynamic
        }

        async function showMyBookmarks() {
            if(!currentUser) { openLoginModal(); return; }
            document.getElementById('homeSection').classList.remove('hero-section'); // Remove hero height
            document.getElementById('homeSection').innerHTML = ''; // Clear hero
            document.getElementById('featuresSection').style.display = 'none';
            document.getElementById('resultsArea').innerHTML = "";
            document.getElementById('readerView').style.display = "none";
            document.getElementById('bookmarkArea').style.display = 'block';
            
            const list = document.getElementById('bookmarkList');
            list.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';
            
            const { data } = await _supabase.from('bookmarks').select('*').eq('email', currentUser.email);
            if(!data || data.length === 0) { list.innerHTML = '<div class="alert alert-light border">No bookmarks found.</div>'; return; }
            
            list.innerHTML = "";
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.onclick = () => loadJudgment({title: item.case_title, citation: item.case_citation, case_anchor: item.case_anchor, github_filename: item.github_filename, is_premium: true});
                div.innerHTML = `<h5>${item.case_title}</h5><span class="tag tag-cite">${item.case_citation}</span>`;
                list.appendChild(div);
            });
        }

        // --- SEARCH ENGINE ---
        function triggerSearch(page, type = null) { if (type) currentSearchType = type; performSearch(page); }

        async function performSearch(page = 1) {
            currentPage = page;
            const resultsDiv = document.getElementById('resultsArea');
            document.getElementById('readerView').style.display = 'none';
            document.getElementById('bookmarkArea').style.display = 'none';
            document.getElementById('featuresSection').style.display = 'none';
            document.getElementById('packages').style.display = 'none';
            
            // Adjust Hero for Results
            const hero = document.getElementById('homeSection');
            hero.style.minHeight = 'auto';
            hero.style.padding = '40px 15px';
            document.querySelector('.hero-title').style.display = 'none';
            document.querySelector('.hero-subtitle').style.display = 'none';

            const lawFilterVal = document.getElementById('lawFilterInput').value.trim();
            const searchText = document.getElementById('searchInput').value.trim();

            if (currentSearchType !== 'advanced' && !searchText && !lawFilterVal) { alert("Please enter a keyword."); return; }

            resultsDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            
            let queryBuilder = _supabase.from('cases').select('*', { count: 'exact' });
            let highlightTerm = "";

            if (currentSearchType === 'advanced') {
                const jour = document.getElementById('advJournal').value;
                const vol = document.getElementById('advVol').value;
                const div = document.getElementById('advDiv').value;
                const pg = document.getElementById('advPage').value;
                if (!jour || !vol || !div || !pg) { alert("Please fill all fields."); return; }
                queryBuilder = queryBuilder.eq('journal', jour).eq('volume', vol).eq('division', div).eq('page_number', pg);
                highlightTerm = `${jour} ${vol} ${pg}`;
            } else {
                const isExact = document.getElementById('exactMatchToggle').checked;
                let aliasCondition = "";
                if(lawFilterVal) {
                    // Fuzzy match law name from input against aliases
                    for (const [key, aliases] of Object.entries(lawAliases)) {
                        if (key.toLowerCase().includes(lawFilterVal.toLowerCase()) || aliases.some(a => a.toLowerCase().includes(lawFilterVal.toLowerCase()))) {
                            aliasCondition = aliases.map(a => `headnote.ilike.%${a}%`).join(',');
                            break;
                        }
                    }
                    if(!aliasCondition) aliasCondition = `headnote.ilike.%${lawFilterVal}%`;
                }

                if (isExact) {
                    let queryStr = `headnote.ilike.%${searchText}%,title.ilike.%${searchText}%`;
                    if(aliasCondition) queryBuilder = queryBuilder.or(aliasCondition).or(queryStr);
                    else queryBuilder = queryBuilder.or(queryStr);
                    highlightTerm = searchText;
                } else {
                    const words = searchText.split(/\s+/).filter(w => !stopwords.includes(w.toLowerCase()) && w.length > 1);
                    let searchCondition = words.length > 0 ? words.map(w => `headnote.ilike.%${w}%,title.ilike.%${w}%`).join(',') : `headnote.ilike.%${searchText}%,title.ilike.%${searchText}%`;
                    
                    if(aliasCondition) queryBuilder = queryBuilder.or(aliasCondition);
                    if(searchCondition) queryBuilder = queryBuilder.or(searchCondition);
                    highlightTerm = words.join('|');
                }
            }

            const from = (page - 1) * itemsPerPage;
            const to = from + itemsPerPage - 1;
            const { data, error, count } = await queryBuilder.range(from, to).order('page_number', { ascending: true });

            // Premium Gate
            if (currentSearchType === 'advanced' && (!currentUser || !subStatus)) {
                if (count > 0) {
                    new bootstrap.Modal(document.getElementById('advSearchGateModal')).show();
                    resultsDiv.innerHTML = '';
                    return;
                }
            }

            if (error || !data || data.length === 0) {
                resultsDiv.innerHTML = '<div class="text-center mt-5 text-muted"><h5>No cases found.</h5></div>';
                return;
            }

            resultsDiv.innerHTML = `<p class="text-muted small mb-3">Found ${count} results</p>`;
            
            data.forEach(item => {
                const safeHeadnote = item.headnote || "";
                const highlightedHeadnote = highlightText(safeHeadnote, highlightTerm || lawFilterVal);
                
                let citationHtml = (currentUser && subStatus) 
                    ? `<span class="tag tag-cite">${item.citation}</span> ${item.parallel_citations ? '<span class="parallel-cite">| ' + item.parallel_citations + '</span>' : ''}`
                    : `<span class="tag bg-secondary text-white"><i class="fas fa-lock"></i> Premium</span>`;

                const div = document.createElement('div');
                div.className = 'result-item';
                div.onclick = () => loadJudgment(item);
                div.innerHTML = `
                    <h5>${item.title}</h5>
                    <div class="meta-tags">${citationHtml} <span class="tag tag-law">${item.division || 'Supreme Court'}</span></div>
                    <div class="headnote-text headnote-preview">${highlightedHeadnote}</div>
                `;
                resultsDiv.appendChild(div);
            });
            renderPagination(count, page);
        }

        function renderPagination(totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const nav = document.getElementById('paginationNav');
            const list = document.getElementById('paginationList');
            if (totalPages <= 1) { nav.style.display = 'none'; return; }
            nav.style.display = 'block'; list.innerHTML = '';
            
            let start = Math.max(1, currentPage - 2);
            let end = Math.min(totalPages, start + 4);
            
            list.innerHTML += `<li class="page-item ${currentPage===1?'disabled':''}"><button class="page-link" onclick="triggerSearch(${currentPage-1})"><</button></li>`;
            for(let i=start; i<=end; i++) {
                list.innerHTML += `<li class="page-item ${i===currentPage?'active':''}"><button class="page-link" onclick="triggerSearch(${i})">${i}</button></li>`;
            }
            list.innerHTML += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><button class="page-link" onclick="triggerSearch(${currentPage+1})">></button></li>`;
        }

        function highlightText(text, keyword) {
            if (!keyword) return text;
            const parts = keyword.split('|').filter(k => k.length > 0);
            let highlighted = text;
            parts.forEach(part => {
                try {
                    const regex = new RegExp(`(${part})`, "gi");
                    highlighted = highlighted.replace(regex, '<span class="highlight">$1</span>');
                } catch(e) {}
            });
            return highlighted;
        }

        async function loadJudgment(item) {
            if (item.is_premium && !currentUser) { new bootstrap.Modal(document.getElementById('premiumWarningModal')).show(); return; }
            if (item.is_premium && !subStatus) { location.href='#packages'; return; }
            
            document.getElementById('resultsArea').innerHTML = '';
            document.getElementById('paginationNav').style.display = 'none';
            const viewer = document.getElementById('readerView');
            viewer.style.display = 'block';
            viewer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';
            
            try {
                const url = `https://raw.githubusercontent.com/${githubUser}/${repoName}/main/judgments/${item.github_filename}`;
                const res = await fetch(url);
                const fullText = await res.text();
                const start = `===${item.case_anchor}===`;
                const end = `===End===`;
                const sIdx = fullText.indexOf(start);
                let content = sIdx !== -1 ? fullText.substring(sIdx + start.length, fullText.indexOf(end, sIdx)) : "Content Error";
                
                const searchTerm = document.getElementById('searchInput').value;
                if(searchTerm) content = highlightText(content, searchTerm.replace(/\s+/g, '|'));

                viewer.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="triggerSearch(${currentPage})"><i class="fas fa-arrow-left"></i> Back</button>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning text-dark" onclick="toggleBookmark('${item.title}', '${item.citation}', '${item.case_anchor}', '${item.github_filename}')"><i class="far fa-bookmark"></i> Save</button>
                            <button class="btn btn-sm btn-outline-dark" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                        </div>
                    </div>
                    <h3 class="brand-font fw-bold text-center text-primary mb-2">${item.title}</h3>
                    <p class="text-center text-muted fw-bold mb-4">${item.citation}</p>
                    <div class="mt-4 text-justify" style="white-space: pre-wrap;">${content}</div>
                `;
            } catch (e) { viewer.innerHTML = "Error loading judgment from server."; }
        }

        async function toggleBookmark(title, citation, anchor, file) {
            if(!currentUser) { openLoginModal(); return; }
            const { error } = await _supabase.from('bookmarks').insert([{ email: currentUser.email, case_title: title, case_citation: citation, case_anchor: anchor, github_filename: file }]);
            if(error) alert("Already in bookmarks."); else alert("Saved to bookmarks!");
        }
    </script>
</body>
</html>
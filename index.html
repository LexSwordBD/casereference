<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CaseReference | Intelligent Legal Research</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- PREMIUM TYPOGRAPHY & VARIABLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&family=Hind+Siliguri:wght@400;500;600&display=swap');
        
        :root {
            --primary: #0f172a;       
            --accent: #2563eb;        
            --bg-body: #f1f5f9;       
            --surface: #ffffff;       
            --text-main: #1e293b;
            --text-light: #64748b;
        }

        body { 
            background-color: var(--bg-body); 
            font-family: 'Inter', 'Hind Siliguri', sans-serif; 
            color: var(--text-main);
            overflow-x: hidden;
        }

        h1, h2, h3, .brand-font { font-family: 'Playfair Display', serif; }

        /* --- NAVBAR --- */
        .navbar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 12px 0;
            transition: 0.3s;
        }
        .navbar-brand { font-size: 24px; font-weight: 700; color: var(--primary) !important; letter-spacing: -0.5px; }
        .nav-link { font-weight: 500; color: var(--text-main); font-size: 14px; margin: 0 10px; transition: 0.3s; }
        .nav-link:hover { color: var(--accent); }
        
        .btn-app {
            background: #e2e8f0; color: var(--text-main); border-radius: 50px;
            padding: 8px 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; text-decoration: none;
        }
        .btn-app:hover { background: var(--text-main); color: white; }

        /* --- HERO SECTION (Collapsible) --- */
        .hero-section {
            min-height: 85vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at 50% 50%, #ffffff 0%, #e2e8f0 100%);
            padding: 20px;
            transition: all 0.6s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        /* Class to shrink hero after search */
        .hero-section.shrunk {
            min-height: 20vh;
            padding-top: 100px;
            padding-bottom: 30px;
            background: #fff;
            border-bottom: 1px solid #eee;
        }
        .hero-section.shrunk .hero-title, 
        .hero-section.shrunk .hero-subtitle {
            display: none;
        }

        .hero-content { text-align: center; width: 100%; max-width: 850px; z-index: 2; }
        .hero-title { font-size: 42px; font-weight: 700; color: var(--primary); margin-bottom: 15px; }
        .hero-subtitle { font-size: 16px; color: var(--text-light); margin-bottom: 40px; }

        /* --- UNIFIED SEARCH BAR --- */
        .search-container-box {
            background: var(--surface);
            padding: 8px;
            border-radius: 50px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 0; /* Gap 0 to merge visuals */
            transition: 0.3s;
        }
        .search-container-box:focus-within {
            box-shadow: 0 15px 50px -10px rgba(37, 99, 235, 0.2);
            border-color: var(--accent);
        }

        /* Law Filter Input */
        .law-select-wrapper {
            position: relative;
            width: 35%;
            border-right: 1px solid #eee;
            padding-left: 10px;
        }
        .law-input {
            width: 100%; border: none; font-size: 14px; font-weight: 500; color: var(--primary);
            background: transparent; outline: none; padding: 12px; cursor: pointer;
            font-family: 'Inter', 'Hind Siliguri', sans-serif;
        }

        /* Main Search Input */
        .main-input {
            width: 55%; border: none; font-size: 15px; outline: none; color: var(--text-main); padding: 12px 15px;
            background: transparent; font-family: 'Inter', 'Hind Siliguri', sans-serif;
        }

        /* Search Button */
        .btn-search-hero {
            background: var(--accent); color: white; border: none;
            width: 45px; height: 45px; border-radius: 50%;
            font-size: 16px; transition: 0.3s; cursor: pointer; margin-right: 5px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-search-hero:hover { background: #1d4ed8; transform: scale(1.05); }

        /* Advanced Options */
        .search-options { display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 13px; color: var(--text-light); }
        .adv-search-panel { display: none; background: #fff; border-radius: 12px; padding: 25px; margin-top: 15px; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

        /* --- RESULTS (List View) --- */
        .result-item {
            background: var(--surface); border: 1px solid #e2e8f0;
            padding: 30px; border-radius: 12px;
            margin-bottom: 20px; transition: 0.2s; position: relative;
            cursor: pointer;
        }
        .result-item:hover { border-color: var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .result-item h5 { color: var(--accent); font-family: 'Playfair Display', serif; font-weight: 700; font-size: 20px; margin-bottom: 10px; }
        
        /* Full Headnote Display */
        .headnote-text { 
            font-size: 16px; color: #334155; line-height: 1.8; margin-top: 15px;
            white-space: pre-wrap; font-family: 'Hind Siliguri', serif;
            text-align: justify;
        }
        .highlight { background-color: #fef08a; padding: 2px 4px; border-radius: 3px; font-weight: bold; }
        .tag-cite { background: #eff6ff; color: var(--accent); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }

        /* --- PRICING SECTION (Matches Your Screenshot) --- */
        .packages-section { padding: 80px 15px; background: #fff; }
        .pricing-header { text-align: center; margin-bottom: 50px; }
        .pricing-header h2 { font-family: 'Playfair Display', serif; font-weight: 700; color: var(--text-dark); }
        
        .pricing-card {
            background: #f8fafc; border-radius: 16px; padding: 40px 20px; text-align: center;
            border: 1px solid transparent; transition: 0.3s; position: relative;
        }
        /* Best Value Card Style */
        .pricing-card.best-value {
            background: #fff;
            border: 2px solid var(--accent);
            box-shadow: 0 20px 40px rgba(37, 99, 235, 0.1);
            transform: scale(1.05); z-index: 2;
        }
        .badge-best {
            position: absolute; top: 0; right: 0; background: var(--accent); color: white;
            padding: 5px 15px; font-size: 10px; font-weight: 700; text-transform: uppercase;
            border-bottom-left-radius: 10px;
        }
        .plan-name { font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 10px; }
        .plan-price { font-size: 36px; font-weight: 700; color: var(--text-dark); font-family: 'Inter', sans-serif; }
        .billing-cycle { font-size: 13px; color: var(--text-light); margin-bottom: 25px; }
        
        .btn-pricing {
            display: inline-block; width: 100%; padding: 12px; border-radius: 8px;
            font-weight: 600; font-size: 14px; text-decoration: none; margin-top: 15px; transition: 0.3s;
        }
        .btn-pricing.basic { background: #e2e8f0; color: var(--text-dark); }
        .btn-pricing.basic:hover { background: #cbd5e1; }
        .btn-pricing.primary { background: var(--text-dark); color: white; }
        .btn-pricing.primary:hover { background: var(--primary); }

        /* Pagination */
        .pagination { justify-content: center; margin-top: 40px; padding-bottom: 40px; }
        .page-link { color: var(--text-dark); border: none; margin: 0 5px; border-radius: 5px; font-weight: 600; }
        .page-item.active .page-link { background-color: var(--accent); color: white; }

        /* Footer */
        footer { background: #1e293b; color: #94a3b8; padding: 60px 0; font-size: 14px; margin-top: 50px; }
        footer h5 { color: white; margin-bottom: 20px; }
        .footer-link { color: #94a3b8; text-decoration: none; margin: 0 10px; }
        .footer-link:hover { color: white; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            .hero-section { padding-top: 100px; padding-bottom: 40px; }
            .hero-title { font-size: 30px; }
            
            /* Mobile Search Box Separation */
            .search-container-box {
                flex-direction: column;
                background: transparent;
                box-shadow: none;
                border: none;
                padding: 0;
            }
            .law-select-wrapper {
                width: 100%; border: none; margin-bottom: 10px;
                background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            }
            .main-input {
                width: 100%; margin-bottom: 10px;
                background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            }
            .btn-search-hero {
                width: 100%; border-radius: 12px;
            }
            
            .pricing-card.best-value { transform: scale(1); margin: 20px 0; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand brand-font" href="#" onclick="location.reload()">Case<span>Reference</span></a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="resetHome()">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showMyBookmarks()">Bookmarks</a></li>
                    <li class="nav-item"><a class="nav-link" href="#packages">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link" href="#contact">Contact</a></li>
                    <li class="nav-item ms-lg-2">
                        <a class="btn-app" href="#" data-bs-toggle="modal" data-bs-target="#appModal">
                            <i class="fas fa-robot"></i> Get App
                        </a>
                    </li>
                    <li class="nav-item ms-lg-3 mt-3 mt-lg-0" id="authDiv"></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="hero-section" id="homeSection">
        <div class="hero-content">
            <h1 class="hero-title">The Legal Intelligence.</h1>
            <p class="hero-subtitle">Comprehensive database of Supreme Court judgments.</p>
            
            <div class="search-container">
                <div class="search-container-box">
                    <div class="law-select-wrapper">
                        <input class="law-input" list="lawList" id="lawFilterInput" placeholder="Select Law (e.g. Penal Code)" onchange="triggerSearch(1)">
                        <datalist id="lawList">
                            <option value="Constitution of Bangladesh (সংবিধান)">
                            <option value="Code of Civil Procedure (CPC)">
                            <option value="Code of Criminal Procedure (CrPC)">
                            <option value="Penal Code (দণ্ডবিধি)">
                            <option value="Evidence Act (সাক্ষ্য আইন)">
                            <option value="Specific Relief Act">
                            <option value="Limitation Act">
                            <option value="Nari O Shishu Nirjatan Daman Ain">
                            <option value="Artha Rin Adalat Ain">
                            <option value="Digital Security Act">
                            <option value="Narcotics Control Act">
                            <option value="Labor Act">
                            <option value="Negotiable Instruments Act (NI Act)">
                            <option value="Transfer of Property Act">
                            <option value="Registration Act">
                            <option value="Family Courts Ordinance">
                            <option value="Muslim Family Laws">
                            <option value="Special Powers Act">
                            <option value="Anti-Terrorism Act">
                            <option value="Arms Act">
                            <option value="Mobile Court Act">
                            <option value="VAT Act">
                            <option value="Income Tax Ordinance">
                        </datalist>
                    </div>

                    <input type="text" id="searchInput" class="main-input" maxlength="80" placeholder="Search keywords, citations...">
                    
                    <button class="btn btn-light rounded-circle ms-2" onclick="toggleAdvSearch()" style="width:40px;height:40px;"><i class="fas fa-sliders-h"></i></button>
                    <button class="btn-search-hero ms-2" onclick="triggerSearch(1)"><i class="fas fa-arrow-right"></i></button>
                </div>

                <div class="search-options">
                    <label style="cursor:pointer;"><input type="checkbox" id="exactMatchToggle"> Exact Phrase Match</label>
                </div>

                <div class="adv-search-panel" id="advSearchForm">
                    <h6 class="text-secondary small fw-bold mb-3">CITATION SEARCH</h6>
                    <div class="row g-2">
                        <div class="col-6 col-md-3"><select id="advJournal" class="form-select form-select-sm"><option value="">Journal</option><option>DLR</option><option>BLD</option><option>ADC</option><option>MLR</option><option>BLC</option></select></div>
                        <div class="col-6 col-md-2"><input type="text" id="advVol" class="form-control form-control-sm" placeholder="Vol"></div>
                        <div class="col-6 col-md-3"><select id="advDiv" class="form-select form-select-sm"><option value="">Div</option><option>AD</option><option>HCD</option></select></div>
                        <div class="col-6 col-md-2"><input type="text" id="advPage" class="form-control form-control-sm" placeholder="Page"></div>
                        <div class="col-12 col-md-2"><button class="btn btn-dark btn-sm w-100" onclick="triggerSearch(1, 'advanced')">Find</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="min-height: 500px;">
        <div id="resultsArea"></div>
        <nav id="paginationNav" style="display:none;"><ul class="pagination" id="paginationList"></ul></nav>
        
        <div id="readerView" class="bg-white p-4 p-md-5 rounded-3 shadow-sm border mb-5" style="display:none;"></div>
        <div id="bookmarkArea" style="display:none;" class="mb-5"><h3 class="mb-4 brand-font">My Bookmarks</h3><div id="bookmarkList"></div></div>

        <div id="paywallMsg" class="text-center py-5 bg-white rounded shadow-sm border" style="display:none; margin-bottom:50px;">
            <i class="fas fa-crown fa-3x text-warning mb-3"></i>
            <h3>Premium Access Required</h3>
            <p class="text-muted">Please subscribe to view full content.</p>
            <a href="#packages" class="btn btn-dark rounded-pill px-5 mt-2">View Pricing</a>
        </div>
    </div>

    <div class="packages-section" id="packages">
        <div class="container">
            <div class="pricing-header">
                <h2>Simple, Transparent Pricing</h2>
                <p class="text-muted">Choose the plan that fits your practice.</p>
            </div>
            <div class="row g-4 justify-content-center align-items-center">
                <div class="col-md-3 col-sm-6">
                    <div class="pricing-card">
                        <div class="plan-name">Monthly</div>
                        <div class="plan-price">199৳</div>
                        <div class="billing-cycle">Billed monthly</div>
                        <a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt199/4NosNL" target="_blank" class="btn-pricing basic">Get Started</a>
                    </div>
                </div>
                
                <div class="col-md-3 col-sm-6">
                    <div class="pricing-card best-value">
                        <div class="badge-best">BEST VALUE</div>
                        <div class="plan-name">Quarterly</div>
                        <div class="plan-price">499৳</div>
                        <div class="billing-cycle">Save 15%</div>
                        <a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt499/IxcDIa" target="_blank" class="btn-pricing primary">Get Started</a>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6">
                    <div class="pricing-card">
                        <div class="plan-name">Half-Yearly</div>
                        <div class="plan-price">700৳</div>
                        <div class="billing-cycle">Save 30%</div>
                        <a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt700/LO7ESu" target="_blank" class="btn-pricing basic">Get Started</a>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6">
                    <div class="pricing-card">
                        <div class="plan-name">Yearly</div>
                        <div class="plan-price">1200৳</div>
                        <div class="billing-cycle">Save 50%</div>
                        <a href="https://shop.bkash.com/ak-jurist-law-firm01911008518/pay/bdt1200/O3FBxR" target="_blank" class="btn-pricing basic">Get Started</a>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-5">
                <button class="btn btn-dark rounded-pill px-5" data-bs-toggle="modal" data-bs-target="#paymentModal">
                    Already paid? Confirm here
                </button>
            </div>
        </div>
    </div>

    <footer id="contact">
        <div class="container text-center">
            <h4 class="text-white mb-4 brand-font">CaseReference BD</h4>
            <div class="mb-4">
                <a href="#" class="footer-link">Home</a>
                <a href="#" class="footer-link">Privacy</a>
                <a href="#" class="footer-link">Terms</a>
            </div>
            <p class="mb-1 text-light">Bashundhara Riverview, Dhaka.</p>
            <p class="mb-4 text-light">Phone: 01911 008 518 | Email: legalvoicebd@gmail.com</p>
            <p class="small opacity-50">&copy; 2026 CaseReference. All Rights Reserved.</p>
        </div>
    </footer>

    <a href="https://wa.me/8801911008518" class="whatsapp-float" target="_blank"><i class="fab fa-whatsapp"></i></a>

    <div class="modal fade" id="appModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-mobile-alt fa-3x text-success mb-3"></i><h3>Coming Soon</h3><p class="text-muted">Our Android & iOS App is under development.</p><button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Close</button></div></div></div></div>
    <div class="modal fade" id="advSearchGateModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-check-circle fa-4x text-success mb-4"></i><h3>Judgment Found!</h3><p class="text-muted">Advanced Search is a Premium Feature.</p><button class="btn btn-dark w-100" onclick="location.href='#packages'; bootstrap.Modal.getInstance(document.getElementById('advSearchGateModal')).hide();">View Plans</button></div></div></div></div>
    <div class="modal fade" id="loginModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Login</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><input type="email" id="loginEmailInput" class="form-control mb-3" placeholder="Enter email"><button class="btn btn-dark w-100" onclick="submitLogin()">Send Magic Link</button></div></div></div></div>
    <div class="modal fade" id="checkEmailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-envelope fa-3x text-success"></i><h3>Check Email</h3><p>Login link sent.</p><button class="btn btn-outline-success" data-bs-dismiss="modal">OK</button></div></div></div></div>
    <div class="modal fade" id="premiumWarningModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-5"><div class="modal-body"><i class="fas fa-lock fa-3x text-warning"></i><h3>Premium Only</h3><p>Please login to view.</p><button class="btn btn-dark" onclick="triggerLoginFromModal()">Login</button></div></div></div></div>
    <div class="modal fade" id="paymentModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5>Verify Payment</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><form action="https://formsubmit.co/caseref.bd@gmail.com" method="POST"><input type="hidden" name="_captcha" value="false"><input type="text" name="Name" class="form-control mb-3" placeholder="Name" required><input type="text" name="Phone" class="form-control mb-3" placeholder="Phone" required><input type="email" name="Email" class="form-control mb-3" placeholder="Email" required><input type="text" name="TrxID" class="form-control mb-3" placeholder="TrxID" required><select name="Package" class="form-select mb-3"><option>Monthly</option><option>Quarterly</option><option>Yearly</option></select><button class="btn btn-success w-100">Submit</button></form></div></div></div></div>
    
    <div class="modal fade" id="profileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content text-center p-4"><div class="modal-body"><h4 class="mb-3">My Profile</h4><div id="profileInfo" class="mb-4"></div><button class="btn btn-outline-danger btn-sm" onclick="logout()">Sign Out</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const supabaseUrl = 'https://bxzrydybnnlzrgzdqnob.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4enJ5ZHlibm5senJnemRxbm9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTQ2MzksImV4cCI6MjA4NDEzMDYzOX0.6Ikj5At5UKhKZr6y_lhmOQ-FUDxdnJOS1ZUSf6dTgEI'; 
        const githubUser = 'LexSwordBD'; 
        const repoName = 'casereference'; 
        const siteLink = 'https://lexswordbd.github.io/casereference/';

        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        let currentUser = null;
        let subStatus = false;
        let currentPage = 1;
        const itemsPerPage = 20;
        let currentSearchType = 'simple';

        // --- FULL RESTORED LOGIC ---
        const lawAliases = {
            'Constitution': ['Constitution', 'Konstitution', 'Art.', 'Article', 'সংবিধান'],
            'Code of Civil Procedure': ['CPC', 'Code of Civil Procedure', 'Civil Procedure Code', 'C.P.C', 'দেওয়ানী কার্যবিধি', 'Order', 'Rule'],
            'Code of Criminal Procedure': ['CrPC', 'Code of Criminal Procedure', 'Criminal Procedure Code', 'Cr.P.C', 'ফৌজদারী কার্যবিধি', 'Section 144', '498'],
            'Penal Code': ['Penal Code', 'Penal', 'PC', 'P.C', 'dondobidhi', 'দণ্ডবিধি', '302', '304'],
            'Evidence Act': ['Evidence Act', 'Evidence', 'sakkho ain', 'সাক্ষ্য আইন'],
            'Limitation Act': ['Limitation Act', 'Limitation', 'Section 5', 'তামাদি'],
            'Specific Relief Act': ['Specific Relief', 'SR Act', 'S.R. Act', 'সুনির্দিষ্ট প্রতিকার'],
            'Nari O Shishu': ['Nari O Shishu', 'Women and Children', 'Nari-O-Shishu', 'নারী ও শিশু'],
            'Artha Rin': ['Artha Rin', 'Money Loan Court', 'Artha Rin Adalat', 'অর্থ ঋণ'],
            'Digital Security': ['Digital Security', 'Cyber Security', 'ICT Act', 'ডিজিটাল নিরাপত্তা'],
            'Narcotics': ['Narcotics', 'Madok', 'Drug', 'Table 9(Ka)', 'মাদক', 'Heroin', 'Yaba'],
            'Labor Act': ['Labor Act', 'Labour Act', 'Labour Law', 'Employment of Labour', 'Srom Ain', 'শ্রম আইন'],
            'Negotiable Instruments': ['Negotiable Instruments', 'NI Act', 'N.I. Act', '138', 'Dishonour of Cheque', 'চেক ডিজঅনার'],
            'Transfer of Property': ['Transfer of Property', 'TP Act', 'T.P. Act', 'সম্পত্তি হস্তান্তর'],
            'Registration Act': ['Registration Act', 'রেজিস্ট্রেশন']
        };
        const stopwords = ['a', 'an', 'the', 'of', 'in', 'and', 'or', 'is', 'are', 'was', 'were', 'be', 'to', 'for', 'with', 'on', 'at', 'by', 'from', 'shall', 'will', 'am'];

        async function checkAuth() {
            const { data: { session } } = await _supabase.auth.getSession();
            const authDiv = document.getElementById('authDiv');
            if (session) {
                currentUser = session.user;
                const { data } = await _supabase.from('members').select('*').eq('email', currentUser.email).single();
                
                let expiryText = "Free Member";
                if(data && new Date(data.expiry_date) > new Date()) {
                    subStatus = true;
                    const daysLeft = Math.ceil((new Date(data.expiry_date) - new Date()) / (1000 * 60 * 60 * 24));
                    expiryText = `Premium (Exp: ${new Date(data.expiry_date).toLocaleDateString()} - ${daysLeft} days left)`;
                }
                
                authDiv.innerHTML = `<button class="btn btn-outline-dark rounded-pill px-3 btn-sm" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="fas fa-user-circle"></i> Account</button>`;
                document.getElementById('profileInfo').innerHTML = `<p class="fw-bold mb-1">${currentUser.email}</p><span class="badge ${subStatus ? 'bg-success' : 'bg-warning text-dark'}">${expiryText}</span>`;
            } else {
                authDiv.innerHTML = `<button class="btn btn-dark rounded-pill px-4 btn-sm" onclick="openLoginModal()">Login</button>`;
            }
        }
        checkAuth();

        function openLoginModal() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
        async function submitLogin() {
            const email = document.getElementById('loginEmailInput').value;
            if(!email) return alert("Please enter email.");
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            const { error } = await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: siteLink } });
            if(!error) new bootstrap.Modal(document.getElementById('checkEmailModal')).show();
            else alert(error.message);
        }
        function triggerLoginFromModal() { bootstrap.Modal.getInstance(document.getElementById('premiumWarningModal')).hide(); openLoginModal(); }
        async function logout() { await _supabase.auth.signOut(); location.reload(); }

        function resetHome() { location.reload(); }
        function toggleAdvSearch() { 
            const panel = document.getElementById('advSearchForm');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        
        async function showMyBookmarks() {
            if(!currentUser) { openLoginModal(); return; }
            document.getElementById('homeSection').classList.add('shrunk');
            document.getElementById('resultsArea').innerHTML = "";
            document.getElementById('readerView').style.display = "none";
            document.getElementById('bookmarkArea').style.display = 'block';
            
            const list = document.getElementById('bookmarkList');
            list.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';
            
            const { data } = await _supabase.from('bookmarks').select('*').eq('email', currentUser.email);
            if(!data || data.length === 0) { list.innerHTML = '<div class="alert alert-light border">No bookmarks found.</div>'; return; }
            
            list.innerHTML = "";
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.onclick = () => loadJudgment({title: item.case_title, citation: item.case_citation, case_anchor: item.case_anchor, github_filename: item.github_filename, is_premium: true});
                div.innerHTML = `<h5>${item.case_title}</h5><span class="tag-cite">${item.case_citation}</span>`;
                list.appendChild(div);
            });
        }

        function triggerSearch(page, type = null) { if (type) currentSearchType = type; performSearch(page); }

        async function performSearch(page = 1) {
            currentPage = page;
            const resultsDiv = document.getElementById('resultsArea');
            document.getElementById('readerView').style.display = 'none';
            document.getElementById('bookmarkArea').style.display = 'none';
            document.getElementById('packages').style.display = 'none';
            document.getElementById('paywallMsg').style.display = 'none';
            
            // Hero Shrink Logic
            document.getElementById('homeSection').classList.add('shrunk');

            const lawFilterVal = document.getElementById('lawFilterInput').value.trim();
            const searchText = document.getElementById('searchInput').value.trim();

            if (currentSearchType !== 'advanced' && !searchText && !lawFilterVal) { alert("Please enter a keyword."); return; }

            resultsDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            
            let queryBuilder = _supabase.from('cases').select('*', { count: 'exact' });
            let highlightTerm = "";

            if (currentSearchType === 'advanced') {
                const jour = document.getElementById('advJournal').value;
                const vol = document.getElementById('advVol').value;
                const div = document.getElementById('advDiv').value;
                const pg = document.getElementById('advPage').value;
                if (!jour || !vol || !div || !pg) { alert("Please fill all fields."); return; }
                queryBuilder = queryBuilder.eq('journal', jour).eq('volume', vol).eq('division', div).eq('page_number', pg);
                highlightTerm = `${jour} ${vol} ${pg}`;
            } else {
                const isExact = document.getElementById('exactMatchToggle').checked;
                let aliasCondition = "";
                
                if(lawFilterVal) {
                    for (const [key, aliases] of Object.entries(lawAliases)) {
                        if (key.toLowerCase().includes(lawFilterVal.toLowerCase()) || aliases.some(a => a.toLowerCase().includes(lawFilterVal.toLowerCase()))) {
                            aliasCondition = aliases.map(a => `headnote.ilike.%${a}%`).join(',');
                            break;
                        }
                    }
                    if(!aliasCondition) aliasCondition = `headnote.ilike.%${lawFilterVal}%`;
                }

                if (isExact) {
                    let queryStr = `headnote.ilike.%${searchText}%,title.ilike.%${searchText}%`;
                    if(aliasCondition) queryBuilder = queryBuilder.or(aliasCondition).or(queryStr);
                    else queryBuilder = queryBuilder.or(queryStr);
                    highlightTerm = searchText;
                } else {
                    const words = searchText.split(/\s+/).filter(w => !stopwords.includes(w.toLowerCase()) && w.length > 1);
                    let searchCondition = words.length > 0 ? words.map(w => `headnote.ilike.%${w}%,title.ilike.%${w}%`).join(',') : `headnote.ilike.%${searchText}%,title.ilike.%${searchText}%`;
                    
                    if(aliasCondition) queryBuilder = queryBuilder.or(aliasCondition);
                    if(searchCondition) queryBuilder = queryBuilder.or(searchCondition);
                    highlightTerm = words.join('|');
                }
            }

            const from = (page - 1) * itemsPerPage;
            const to = from + itemsPerPage - 1;
            const { data, error, count } = await queryBuilder.range(from, to).order('page_number', { ascending: true });

            if (currentSearchType === 'advanced' && (!currentUser || !subStatus)) {
                if (count > 0) {
                    new bootstrap.Modal(document.getElementById('advSearchGateModal')).show();
                    resultsDiv.innerHTML = '';
                    return;
                }
            }

            if (error || !data || data.length === 0) {
                resultsDiv.innerHTML = '<div class="text-center mt-5 text-muted"><h5>No cases found.</h5></div>';
                return;
            }

            resultsDiv.innerHTML = `<p class="text-muted small mb-3">Found ${count} results</p>`;
            
            data.forEach(item => {
                const safeHeadnote = item.headnote || "";
                const highlightedHeadnote = highlightText(safeHeadnote, highlightTerm || lawFilterVal);
                
                let citationHtml = (currentUser && subStatus) 
                    ? `<span class="tag-cite">${item.citation}</span> ${item.parallel_citations ? '<span class="parallel-cite">| ' + item.parallel_citations + '</span>' : ''}`
                    : `<span class="badge bg-secondary opacity-50"><i class="fas fa-lock small"></i> Premium</span>`;

                const div = document.createElement('div');
                div.className = 'result-item';
                div.onclick = () => loadJudgment(item);
                div.innerHTML = `
                    <h5>${item.title}</h5>
                    <div class="mb-2">${citationHtml} <span class="badge bg-light text-dark border ms-2">${item.division || 'SC'}</span></div>
                    <div class="headnote-text">${highlightedHeadnote}</div>
                `;
                resultsDiv.appendChild(div);
            });
            renderPagination(count, page);
        }

        function renderPagination(totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const nav = document.getElementById('paginationNav');
            const list = document.getElementById('paginationList');
            if (totalPages <= 1) { nav.style.display = 'none'; return; }
            nav.style.display = 'block'; list.innerHTML = '';
            
            let start = Math.max(1, currentPage - 2);
            let end = Math.min(totalPages, start + 4);
            
            list.innerHTML += `<li class="page-item ${currentPage===1?'disabled':''}"><button class="page-link" onclick="triggerSearch(${currentPage-1})"><</button></li>`;
            for(let i=start; i<=end; i++) {
                list.innerHTML += `<li class="page-item ${i===currentPage?'active':''}"><button class="page-link" onclick="triggerSearch(${i})">${i}</button></li>`;
            }
            list.innerHTML += `<li class="page-item ${currentPage===totalPages?'disabled':''}"><button class="page-link" onclick="triggerSearch(${currentPage+1})">></button></li>`;
        }

        function highlightText(text, keyword) {
            if (!keyword) return text;
            const parts = keyword.split('|').filter(k => k.length > 0);
            let highlighted = text;
            parts.forEach(part => {
                try {
                    const regex = new RegExp(`(${part})`, "gi");
                    highlighted = highlighted.replace(regex, '<span class="highlight">$1</span>');
                } catch(e) {}
            });
            return highlighted;
        }

        async function loadJudgment(item) {
            if (item.is_premium && !currentUser) { new bootstrap.Modal(document.getElementById('premiumWarningModal')).show(); return; }
            if (item.is_premium && !subStatus) { document.getElementById('resultsArea').innerHTML=''; document.getElementById('paywallMsg').style.display='block'; return; }
            
            document.getElementById('resultsArea').innerHTML = '';
            document.getElementById('paginationNav').style.display = 'none';
            const viewer = document.getElementById('readerView');
            viewer.style.display = 'block';
            viewer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';
            
            try {
                const url = `https://raw.githubusercontent.com/${githubUser}/${repoName}/main/judgments/${item.github_filename}`;
                const res = await fetch(url);
                const fullText = await res.text();
                const start = `===${item.case_anchor}===`;
                const end = `===End===`;
                const sIdx = fullText.indexOf(start);
                let content = sIdx !== -1 ? fullText.substring(sIdx + start.length, fullText.indexOf(end, sIdx)) : "Content Error";
                
                const searchTerm = document.getElementById('searchInput').value;
                if(searchTerm) content = highlightText(content, searchTerm.replace(/\s+/g, '|'));

                viewer.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                        <button class="btn btn-outline-secondary btn-sm" onclick="triggerSearch(${currentPage})"><i class="fas fa-arrow-left"></i> Back</button>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning text-dark" onclick="toggleBookmark('${item.title}', '${item.citation}', '${item.case_anchor}', '${item.github_filename}')"><i class="far fa-bookmark"></i> Save</button>
                            <button class="btn btn-sm btn-outline-dark" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
                        </div>
                    </div>
                    <h3 class="brand-font fw-bold text-center text-primary mb-2">${item.title}</h3>
                    <p class="text-center text-muted fw-bold mb-4">${item.citation}</p>
                    <div class="mt-4 text-justify" style="white-space: pre-wrap;">${content}</div>
                `;
            } catch (e) { viewer.innerHTML = "Error loading judgment from server."; }
        }

        async function toggleBookmark(title, citation, anchor, file) {
            if(!currentUser) { openLoginModal(); return; }
            const { error } = await _supabase.from('bookmarks').insert([{ email: currentUser.email, case_title: title, case_citation: citation, case_anchor: anchor, github_filename: file }]);
            if(error) alert("Already in bookmarks."); else alert("Saved to bookmarks!");
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseReference | Advanced Legal Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        
        /* ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶ø‡¶Ç */
        .navbar { background: #fff; border-bottom: 1px solid #ddd; padding: 15px 0; }
        .brand { font-size: 24px; font-weight: bold; color: #2c3e50; text-decoration: none; }
        .brand span { color: #d35400; }

        /* ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶∏‡ßá‡¶ï‡¶∂‡¶® */
        .search-area { background: white; padding: 40px 20px; border-bottom: 1px solid #eee; }
        .search-container { max-width: 800px; margin: 0 auto; }
        
        .main-search-box { position: relative; }
        .search-input { 
            width: 100%; height: 55px; border-radius: 8px; border: 2px solid #e9ecef; 
            padding: 0 120px 0 20px; font-size: 18px; outline: none; transition: 0.3s;
        }
        .search-input:focus { border-color: #d35400; box-shadow: 0 0 10px rgba(211, 84, 0, 0.1); }
        
        .action-btns { position: absolute; right: 10px; top: 8px; }
        
        /* ‡¶è‡¶°‡¶≠‡¶æ‡¶®‡ßç‡¶∏‡¶° ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ */
        .adv-search-panel { 
            display: none; background: #f8f9fa; border: 1px solid #ddd; 
            padding: 20px; border-radius: 8px; margin-top: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .result-card { 
            background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; 
            border: 1px solid #eee; cursor: pointer; transition: 0.2s; 
        }
        .result-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: #d35400; }
        
        .highlight { background-color: #fff3cd; font-weight: bold; padding: 0 2px; border-radius: 2px; }
        
        /* ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶π‡ßá‡¶°‡¶®‡ßã‡¶ü ‡¶ú‡¶æ‡¶∏‡ßç‡¶ü‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
        .headnote-text { 
            font-size: 15px; color: #444; line-height: 1.6; margin-top: 10px; 
            text-align: justify; /* ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶¶‡ßÅ‡¶á ‡¶™‡¶æ‡¶∂‡ßá ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
        }

        /* ‡¶∞‡¶ø‡¶°‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶° */
        #readerView { display: none; background: white; padding: 50px; border-radius: 8px; font-family: 'Times New Roman', serif; font-size: 19px; line-height: 1.8; text-align: justify; }
        
        /* ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶ó‡¶á‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶ï‡ßç‡¶∏ */
        .paywall { display: none; text-align: center; padding: 50px; background: white; border-radius: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container d-flex justify-content-between">
            <a href="#" class="brand" onclick="location.reload()"><span>Case</span>Reference</a>
            <div id="authDiv"></div>
        </div>
    </nav>

    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">My Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="profileInfo">Checking...</div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button class="btn btn-danger btn-sm px-4" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loginWarningModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">üîí Login Required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <p class="lead">‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø <strong>Premium</strong> ‡¶ú‡¶æ‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡•§</p>
                    <p class="text-muted">‡¶™‡ßÅ‡¶∞‡ßã ‡¶∞‡¶æ‡ßü ‡¶™‡ßú‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶∞‡¶ø‡¶®‡¶ø‡¶â ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
                    <button class="btn btn-dark w-100 mt-3" onclick="triggerLoginFromModal()">Login with Email</button>
                </div>
            </div>
        </div>
    </div>

    <div class="search-area" id="searchSection">
        <div class="search-container">
            <div class="main-search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="Search keywords (e.g. Murder, Fraud, Section 302)...">
                <div class="action-btns">
                    <button class="btn btn-outline-secondary" onclick="toggleAdvSearch()" title="Advanced Search"><i class="fas fa-sliders-h"></i></button>
                    <button class="btn btn-danger" onclick="performSearch('simple')">Search</button>
                </div>
            </div>

            <div class="adv-search-panel" id="advSearchForm">
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Journal</label>
                        <select id="advJournal" class="form-select">
                            <option value="">Select...</option>
                            <option value="DLR">DLR</option>
                            <option value="BLD">BLD</option>
                            <option value="ADC">ADC</option>
                            <option value="ALR">ALR</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Volume</label>
                        <input type="text" id="advVol" class="form-control" placeholder="75">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Division</label>
                        <select id="advDiv" class="form-select">
                            <option value="">Any</option>
                            <option value="AD">Appellate (AD)</option>
                            <option value="HCD">High Court (HCD)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">Page</label>
                        <input type="text" id="advPage" class="form-control" placeholder="45">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-dark w-100" onclick="performSearch('advanced')">Find</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4 mb-5">
        <div id="resultsArea"></div>
        
        <div id="paywallMsg" class="paywall shadow-sm">
            <i class="fas fa-crown fa-3x text-warning mb-3"></i>
            <h3>Subscription Expired</h3>
            <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶∂‡¶ø‡¶™ ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡•§</p>
            <div class="alert alert-info d-inline-block">
                ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø: <strong>017XXXXXXXX</strong> (500 Tk/Month)
            </div>
            <p class="small mt-2">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶π‡ßã‡ßü‡¶æ‡¶ü‡¶∏‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        </div>

        <div id="readerView" class="shadow-sm"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const supabaseUrl = 'https://bxzrydybnnlzrgzdqnob.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4enJ5ZHlibm5senJnemRxbm9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NTQ2MzksImV4cCI6MjA4NDEzMDYzOX0.6Ikj5At5UKhKZr6y_lhmOQ-FUDxdnJOS1ZUSf6dTgEI'; 
        const githubUser = 'LexSwordBD'; 
        const repoName = 'casereference'; 
        const siteLink = 'https://lexswordbd.github.io/casereference/';
        // ============================================

        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        let currentUser = null;
        let subStatus = false;
        let subExpiry = "Not Active";

        // ‡¶Ö‡¶•‡ßá‡¶®‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ö‡ßá‡¶ï
        async function checkAuth() {
            const { data: { session } } = await _supabase.auth.getSession();
            const authDiv = document.getElementById('authDiv');
            
            if (session) {
                currentUser = session.user;
                // ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶∂‡¶ø‡¶™ ‡¶ö‡ßá‡¶ï
                const { data } = await _supabase.from('members').select('*').eq('email', currentUser.email).single();
                
                if(data && new Date(data.expiry_date) > new Date()) {
                    subStatus = true;
                    subExpiry = new Date(data.expiry_date).toDateString();
                } else {
                    subStatus = false;
                    subExpiry = "Expired";
                }

                // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶π‡¶¨‡ßá ‡¶®‡¶æ, ‡¶¨‡¶∞‡¶Ç ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ñ‡ßÅ‡¶≤‡¶¨‡ßá
                authDiv.innerHTML = `
                    <button class="btn btn-sm btn-outline-dark rounded-pill" data-bs-toggle="modal" data-bs-target="#profileModal">
                        <i class="fas fa-user-circle"></i> ${subStatus ? 'Premium Member' : 'Account'}
                    </button>`;
                
                // ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                document.getElementById('profileInfo').innerHTML = `
                    <p class="fw-bold">${currentUser.email}</p>
                    <hr>
                    <p>Status: <span class="badge ${subStatus ? 'bg-success' : 'bg-danger'}">${subStatus ? 'Active' : 'Expired'}</span></p>
                    <p>Valid Till: <strong>${subExpiry}</strong></p>
                `;

            } else {
                authDiv.innerHTML = `<button class="btn btn-dark rounded-pill" onclick="login()">Login</button>`;
            }
        }
        checkAuth();

        async function login() {
            const email = prompt("Enter your Email address:");
            if(email) await _supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: siteLink } });
        }
        
        // ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        async function triggerLoginFromModal() {
            // ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
            const modalEl = document.getElementById('loginWarningModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            // ‡¶≤‡¶ó‡¶á‡¶® ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ
            login();
        }

        async function logout() { await _supabase.auth.signOut(); location.reload(); }

        function toggleAdvSearch() {
            const panel = document.getElementById('advSearchForm');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        async function performSearch(type) {
            const resultsDiv = document.getElementById('resultsArea');
            document.getElementById('readerView').style.display = 'none';
            document.getElementById('paywallMsg').style.display = 'none';
            resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-warning"></div></div>';

            let queryBuilder = _supabase.from('cases').select('*');
            let highlightTerm = "";

            if (type === 'advanced') {
                const jour = document.getElementById('advJournal').value;
                const vol = document.getElementById('advVol').value;
                const div = document.getElementById('advDiv').value;
                const pg = document.getElementById('advPage').value;
                if (!jour && !vol && !pg) { alert("Please fill at least Journal and Page."); return; }
                if(jour) queryBuilder = queryBuilder.eq('journal', jour);
                if(vol) queryBuilder = queryBuilder.eq('volume', vol);
                if(div) queryBuilder = queryBuilder.eq('division', div);
                if(pg) queryBuilder = queryBuilder.eq('page_number', pg);
                highlightTerm = `${jour} ${vol} ${pg}`;
            } else {
                const text = document.getElementById('searchInput').value;
                if (!text) return;
                queryBuilder = queryBuilder.or(`headnote.ilike.%${text}%,title.ilike.%${text}%`);
                highlightTerm = text;
            }

            const { data, error } = await queryBuilder.limit(20);

            if (error || !data.length) {
                resultsDiv.innerHTML = '<div class="text-center mt-4">No records found.</div>';
                return;
            }

            resultsDiv.innerHTML = `<p class="text-muted small">Found ${data.length} results</p>`;
            data.forEach(item => {
                const safeHeadnote = item.headnote || "No headnote available";
                const highlightedHeadnote = highlightText(safeHeadnote, highlightTerm);

                const div = document.createElement('div');
                div.className = 'result-card';
                div.onclick = () => loadJudgment(item);
                div.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <h5 class="text-primary mb-1">${item.title}</h5>
                        ${item.is_premium ? '<small class="text-danger fw-bold"><i class="fas fa-lock"></i> Premium</small>' : '<small class="text-success">Free</small>'}
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-secondary">${item.citation}</span>
                        <span class="text-muted small ms-2">${item.division || 'HCD/AD'}</span>
                    </div>
                    <div class="headnote-text">${highlightedHeadnote}</div>
                `;
                resultsDiv.appendChild(div);
            });
        }

        function highlightText(text, keyword) {
            if (!keyword) return text;
            const regex = new RegExp(`(${keyword})`, "gi");
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ø‡¶º‡¶æ‡¶Æ ‡¶ö‡ßá‡¶ï ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        async function loadJudgment(item) {
            const viewer = document.getElementById('readerView');
            const paywall = document.getElementById('paywallMsg');
            document.getElementById('resultsArea').innerHTML = '';

            // ‡¶ï‡ßá‡¶∏ ‡ßß: ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ø‡¶º‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶®‡ßá‡¶á
            if (item.is_premium && !currentUser) {
                // ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶®‡¶æ ‡¶ö‡ßá‡ßü‡ßá ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                const loginModal = new bootstrap.Modal(document.getElementById('loginWarningModal'));
                loginModal.show();
                // ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶Ø‡¶æ‡¶§‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∞‡¶ø‡ßü‡ßá ‡¶®‡¶æ ‡¶Ø‡¶æ‡ßü
                performSearch('simple'); 
                return;
            }

            // ‡¶ï‡ßá‡¶∏ ‡ß®: ‡¶≤‡¶ó‡¶á‡¶® ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶®‡ßá‡¶á
            if (item.is_premium && !subStatus) {
                viewer.style.display = 'none';
                paywall.style.display = 'block'; // ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ö‡¶æ‡¶ì‡ßü‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú
                return;
            }

            // ‡¶∏‡¶¨ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
            paywall.style.display = 'none';
            viewer.style.display = 'block';
            viewer.innerHTML = 'Loading judgment...';

            try {
                const url = `https://raw.githubusercontent.com/${githubUser}/${repoName}/main/judgments/${item.github_filename}`;
                const res = await fetch(url);
                const fullText = await res.text();
                const start = `===${item.case_anchor}===`;
                const end = `===End===`;
                const sIdx = fullText.indexOf(start);
                
                let content = "Error parsing file.";
                if(sIdx !== -1) {
                    const eIdx = fullText.indexOf(end, sIdx);
                    if(eIdx !== -1) content = fullText.substring(sIdx + start.length, eIdx);
                }

                const searchTerm = document.getElementById('searchInput').value;
                if(searchTerm) content = highlightText(content, searchTerm);

                viewer.innerHTML = `
                    <button class="btn btn-sm btn-light border mb-3" onclick="location.reload()">Back to Search</button>
                    <h3 class="text-center">${item.title}</h3>
                    <p class="text-center fw-bold text-muted">${item.citation}</p>
                    <hr>
                    ${content}
                `;
            } catch (err) { viewer.innerHTML = "Error loading file."; }
        }
    </script>
</body>
</html>